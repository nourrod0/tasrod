<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الإدارة - نظام تسديد الفواتير</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* تطبيق نفس أسلوب صفحة المستخدم */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            text-align: right;
            margin: 0;
            padding: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* خلفية مشابهة لصفحة المستخدم */
        .container-fluid {
            background: linear-gradient(135deg, #f4f6f8 0%, #e8f0fe 100%);
            min-height: 100vh;
            padding-top: 20px;
            padding-bottom: 40px;
        }

        /* تصميم بطاقات مشابه */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(74, 144, 226, 0.08);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            margin-bottom: 1rem;
            background: white;
        }

        .card:hover {
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.12);
            transform: translateY(-2px);
        }

        .card-header {
            border-radius: 15px 15px 0 0 !important;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            font-weight: bold;
            padding: 1.5rem;
        }

        /* تصميم شريط علوي مشابه لصفحة المستخدم */
        .admin-header {
            background: linear-gradient(135deg, #4a90e2 0%, #3498db 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        /* بطاقات الخدمات الإدارية */
        .admin-service-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            background: white;
            border: none;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .admin-service-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0,123,255,0.1) 0%, rgba(111,66,193,0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .admin-service-card:hover::before {
            opacity: 1;
        }

        .admin-service-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0,123,255,0.15), 0 5px 15px rgba(111,66,193,0.1);
        }

        .admin-service-card.active {
            background: linear-gradient(135deg, rgba(0,123,255,0.1) 0%, rgba(111,66,193,0.05) 100%);
            border-left: 4px solid #007bff;
            transform: translateY(-3px);
        }

        /* أيقونات الخدمات */
        .service-icon {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }

        .admin-service-card:hover .service-icon {
            transform: scale(1.2) rotate(5deg);
        }

        /* بطاقات الإحصائيات */
        .stats-card-modern {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 15px;
            overflow: hidden;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            position: relative;
            border: none;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .stats-card-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0,123,255,0.05) 0%, rgba(111,66,193,0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stats-card-modern:hover::before {
            opacity: 1;
        }

        .stats-card-modern:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1), 0 5px 15px rgba(0,0,0,0.08);
        }

        .stat-icon {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .stats-card-modern:hover .stat-icon {
            transform: scale(1.1);
        }

        /* تصميم الجداول */
        .table-responsive {
            border-radius: 15px;
            background: white;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .table {
            margin: 0;
            border-radius: 15px;
        }

        .table thead th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
            padding: 15px 12px;
            border: none;
        }

        .table tbody tr {
            transition: all 0.3s ease;
            border: none;
        }

        .table tbody td {
            border: none;
            padding: 15px 12px;
            vertical-align: middle;
        }

        .table-hover tbody tr:hover {
            background: linear-gradient(90deg, rgba(0,123,255,0.08) 0%, transparent 100%);
            transform: scale(1.01);
            box-shadow: 0 4px 15px rgba(0,123,255,0.1);
        }

        /* تصميم الأزرار */
        .btn {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #212529;
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        /* تصميم التنبيهات */
        .alert {
            border-radius: 12px;
            border: none;
            padding: 16px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--bs-alert-color);
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(23,162,184,0.1) 0%, rgba(19,132,150,0.05) 100%);
            color: #0c5460;
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(40,167,69,0.1) 0%, rgba(30,126,52,0.05) 100%);
            color: #155724;
        }

        .alert-warning {
            background: linear-gradient(135deg, rgba(255,193,7,0.1) 0%, rgba(224,168,0,0.05) 100%);
            color: #856404;
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(220,53,69,0.1) 0%, rgba(200,35,51,0.05) 100%);
            color: #721c24;
        }

        /* تصميم النماذج */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .modal-header {
            border-bottom: none;
            background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-secondary) 100%);
            padding: 1.5rem 2rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border-top: 1px solid rgba(0,0,0,0.05);
            padding: 1.5rem 2rem;
            background: #f8f9fa;
        }

        /* تصميم الحقول */
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15);
            transform: translateY(-1px);
        }

        /* إخفاء/إظهار الأقسام */
        .admin-section {
            display: none;
            animation: fadeInUp 0.6s ease-out;
        }

        .admin-section.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* الاستجابة للشاشات الصغيرة */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }

            .admin-header {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .card-header {
                padding: 1rem;
            }

            .card-body {
                padding: 1rem;
            }

            .admin-service-card:hover {
                transform: translateY(-3px) scale(1.01);
            }

            .stats-card-modern:hover {
                transform: translateY(-3px) scale(1.01);
            }

            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }

            .modal-dialog {
                margin: 1rem;
                max-width: calc(100% - 20px);
            }

            .modal-body {
                padding: 1.5rem;
            }

            .modal-footer {
                padding: 1rem 1.5rem;
            }
        }

        /* تحسين التمرير */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #007bff, #6f42c1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0056b3, #5a2d91);
        }

        /* تأثيرات إضافية */
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* تحسين الشارات */
        .badge {
            border-radius: 8px;
            padding: 6px 12px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* تحسين أزرار المجموعات */
        .btn-group .btn {
            margin: 0;
            border-radius: 8px;
            margin: 2px;
        }

        .btn-group-sm .btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        /* تحسين جدول الإشعارات */
        #notificationsTableBody tr {
            transition: all 0.3s ease;
        }

        #notificationsTableBody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
        }

        .table th {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 8px;
            border-bottom: 2px solid #dee2e6;
        }

        .table td {
            padding: 12px 8px;
            vertical-align: middle;
            border-bottom: 1px solid #e9ecef;
        }

        .notification-checkbox {
            transform: scale(1.2);
            margin: 0;
        }

        /* تحسين شارات الإشعارات */
        .badge {
            font-size: 10px;
            padding: 4px 8px;
        }

        .text-truncate {
            max-width: 200px;
        }

        /* استجابة الجدول للشاشات الصغيرة */
        @media (max-width: 768px) {
            .table-responsive {
                border-radius: 8px;
            }

            .table th, .table td {
                padding: 8px 4px;
                font-size: 11px;
            }

            .btn-group-sm .btn {
                padding: 4px 8px;
                font-size: 10px;
                margin: 1px;
            }

            .badge {
                font-size: 9px;
                padding: 3px 6px;
            }

            .text-truncate {
                max-width: 100px;
            }

            /* إخفاء بعض الأعمدة في الشاشات الصغيرة */
            .table th:nth-child(4),
            .table td:nth-child(4),
            .table th:nth-child(5),
            .table td:nth-child(5),
            .table th:nth-child(7),
            .table td:nth-child(7),
            .table th:nth-child(8),
            .table td:nth-child(8) {
                display: none;
            }
        }

        @media (max-width: 576px) {
            .card-header {
                padding: 0.75rem;
            }

            .card-header .d-flex {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-check {
                margin-bottom: 0.5rem;
            }

            /* إخفاء المزيد من الأعمدة */
            .table th:nth-child(3),
            .table td:nth-child(3) {
                display: none;
            }

            .table td {
                padding: 6px 4px;
                font-size: 10px;
            }

            .btn-group-sm .btn {
                padding: 3px 6px;
                font-size: 9px;
            }
        }

        /* تحسين التمرير الأفقي */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #dee2e6;
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #adb5bd;
        }

        /* تحسين النصوص القابلة للنقر */
        .user-name-clickable {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            text-decoration: none;
        }

        .user-name-clickable:hover {
            color: #0056b3 !important;
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.1) 0%, rgba(0, 86, 179, 0.05) 100%);
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
        }

        .user-name-clickable::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(to right, #007bff, #0056b3);
            transition: all 0.3s ease;
            transform: translateX(-50%);
            border-radius: 3px;
        }

        .user-name-clickable:hover::before {
            width: 80%;
        }

        /* أزرار العمليات العائمة */
        .action-buttons {
            position: sticky;
            top: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.95) 100%);
            backdrop-filter: blur(10px);
            z-index: 100;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* تحسين قوائم التنقل */
        .nav-menu-item {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            text-decoration: none;
        }

        .nav-menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,123,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-menu-item:hover::before {
            left: 100%;
        }

        .nav-menu-item:hover {
            background: linear-gradient(135deg, rgba(0,123,255,0.08) 0%, rgba(111,66,193,0.05) 100%);
            border-color: rgba(0,123,255,0.2);
            transform: translateX(8px);
            box-shadow: 0 4px 15px rgba(0,123,255,0.1);
        }

        .nav-menu-item.active {
            background: linear-gradient(135deg, rgba(0,123,255,0.15) 0%, rgba(111,66,193,0.1) 100%);
            border-color: #007bff;
            transform: translateX(10px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.2);
        }

        .nav-icon {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .nav-menu-item:hover .nav-icon {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }

        .nav-menu-item.active .nav-icon {
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- الشريط العلوي مع معلومات المدير -->
        <div class="admin-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-1">
                        <i class="fas fa-shield-alt me-2"></i>
                        لوحة الإدارة المتقدمة
                    </h2>
                    <p class="mb-0 opacity-75">
                        <i class="fas fa-user-tie me-1"></i>
                        مرحباً، {{ session.user_name }} - مدير النظام
                    </p>
                </div>
                <div class="col-md-3 text-center">
                    <div class="text-center">
                        <div class="small text-white-50">آخر دخول</div>
                        <div class="h6 mb-0 text-white">
                            <i class="fas fa-clock me-2"></i>
                            <span id="lastLoginTime">الآن</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-end">
                    <div class="d-flex justify-content-end gap-3">
                        <button class="btn btn-outline-light" onclick="refreshAllData()">
                            <i class="fas fa-sync me-2"></i>
                            تحديث البيانات
                        </button>
                        <a href="/logout" class="btn btn-outline-light">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            خروج
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- إعلان النظام للمدير -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info alert-dismissible fade show">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle fa-lg me-3"></i>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-bold">مرحباً بك في لوحة الإدارة المحدثة</h6>
                            <div>تم تحديث التصميم ليصبح أكثر حداثة وسهولة في الاستخدام مع الحفاظ على جميع الوظائف الإدارية</div>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- قائمة الخدمات الإدارية -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tools me-2 text-primary"></i>
                            إدارة النظام
                        </h5>
                    </div>
                    <div class="card-body p-3">
                        <!-- الخدمات الإدارية -->
                        <div class="row g-2">
                            <div class="col-12 mb-3">
                                <div class="admin-service-card card h-100 border-0 active" onclick="showAdminSection('adminMain', this)">
                                    <div class="card-body text-center p-3">
                                        <div class="service-icon bg-info bg-opacity-15 rounded-circle mb-2 mx-auto d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                            <i class="fas fa-chart-bar text-info"></i>
                                        </div>
                                        <div class="fw-bold text-dark">الإحصائيات</div>
                                        <small class="text-muted">عرض البيانات والتقارير</small>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mb-3">
                                <div class="admin-service-card card h-100 border-0" onclick="showAdminSection('users', this)">
                                    <div class="card-body text-center p-3">
                                        <div class="service-icon bg-primary bg-opacity-15 rounded-circle mb-2 mx-auto d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                            <i class="fas fa-users text-primary"></i>
                                        </div>
                                        <div class="fw-bold text-dark">المستخدمين</div>
                                        <small class="text-muted">إدارة حسابات المستخدمين</small>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mb-3">
                                <div class="admin-service-card card h-100 border-0" onclick="showAdminSection('companies', this)">
                                    <div class="card-body text-center p-3">
                                        <div class="service-icon bg-success bg-opacity-15 rounded-circle mb-2 mx-auto d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                            <i class="fas fa-building text-success"></i>
                                        </div>
                                        <div class="fw-bold text-dark">شركات التسديد</div>
                                        <small class="text-muted">إدارة الشركات والفئات</small>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mb-3">
                                <div class="admin-service-card card h-100 border-0" onclick="showAdminSection('customers', this)">
                                    <div class="card-body text-center p-3">
                                        <div class="service-icon bg-warning bg-opacity-15 rounded-circle mb-2 mx-auto d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                            <i class="fas fa-address-book text-warning"></i>
                                        </div>
                                        <div class="fw-bold text-dark">الزبائن</div>
                                        <small class="text-muted">قاعدة بيانات العملاء</small>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mb-3">
                                <div class="admin-service-card card h-100 border-0" onclick="showAdminSection('inquiryRequests', this)">
                                    <div class="card-body text-center p-3">
                                        <div class="service-icon bg-danger bg-opacity-15 rounded-circle mb-2 mx-auto d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                            <i class="fas fa-credit-card text-danger"></i>
                                        </div>
                                        <div class="fw-bold text-dark">طلبات التسديد</div>
                                        <small class="text-muted">مراجعة وموافقة الطلبات</small>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mb-3">
                                <div class="admin-service-card card h-100 border-0" onclick="showAdminSection('adminNotifications', this); setTimeout(() => { loadNotificationsDirectly(); loadNotificationsStatsDirectly(); }, 500);">
                                    <div class="card-body text-center p-3">
                                        <div class="service-icon bg-warning bg-opacity-15 rounded-circle mb-2 mx-auto d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                            <i class="fas fa-bell text-warning"></i>
                                        </div>
                                        <div class="fw-bold text-dark">إدارة الإشعارات</div>
                                        <small class="text-muted">إرسال ومراقبة الإشعارات</small>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mb-3">
                                <div class="admin-service-card card h-100 border-0" onclick="showAdminSection('settings', this)">
                                    <div class="card-body text-center p-3">
                                        <div class="service-icon bg-secondary bg-opacity-15 rounded-circle mb-2 mx-auto d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                            <i class="fas fa-cog text-secondary"></i>
                                        </div>
                                        <div class="fw-bold text-dark">الإعدادات</div>
                                        <small class="text-muted">تكوين النظام والنسخ الاحتياطية</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- المحتوى الإداري -->
            <div class="col-md-9">
                <!-- الإحصائيات -->
                <div id="adminMain" class="admin-section active">
                    <div class="action-buttons">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4><i class="fas fa-chart-bar me-2"></i> إحصائيات النظام</h4>
                            <button class="btn btn-primary" onclick="refreshStats()">
                                <i class="fas fa-sync me-2"></i> تحديث
                            </button>
                        </div>
                    </div>

                    <!-- بطاقات الإحصائيات -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card stats-card-modern h-100">
                                <div class="card-body text-center">
                                    <div class="stat-icon bg-primary bg-opacity-15 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <i class="fas fa-users fa-lg text-primary"></i>
                                    </div>
                                    <h4 class="mb-1 text-primary" id="adminUsersCount">0</h4>
                                    <p class="text-muted mb-0 small">إجمالي المستخدمين</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card stats-card-modern h-100">
                                <div class="card-body text-center">
                                    <div class="stat-icon bg-success bg-opacity-15 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <i class="fas fa-check-circle fa-lg text-success"></i>
                                    </div>
                                    <h4 class="mb-1 text-success" id="adminSuccessful">0</h4>
                                    <p class="text-muted mb-0 small">العمليات الناجحة</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card stats-card-modern h-100">
                                <div class="card-body text-center">
                                    <div class="stat-icon bg-warning bg-opacity-15 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <i class="fas fa-clock fa-lg text-warning"></i>
                                    </div>
                                    <h4 class="mb-1 text-warning" id="adminPending">0</h4>
                                    <p class="text-muted mb-0 small">بانتظار الموافقة</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card stats-card-modern h-100">
                                <div class="card-body text-center">
                                    <div class="stat-icon bg-danger bg-opacity-15 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <i class="fas fa-times-circle fa-lg text-danger"></i>
                                    </div>
                                    <h4 class="mb-1 text-danger" id="adminRejected">0</h4>
                                    <p class="text-muted mb-0 small">العمليات المرفوضة</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم المستخدمين -->
                <div id="users" class="admin-section">
                    <div class="action-buttons">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4><i class="fas fa-users me-2"></i> إدارة المستخدمين</h4>
                            <button class="btn btn-success" onclick="showAddUserModal()">
                                <i class="fas fa-plus me-2"></i> إضافة مستخدم جديد
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>الاسم</th>
                                            <th>رقم الجوال</th>
                                            <th>الرصيد</th>
                                            <th>النوع</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">جاري التحميل...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم الشركات -->
                <div id="companies" class="admin-section">
                    <div class="action-buttons">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4><i class="fas fa-building me-2"></i> شركات التسديد</h4>
                            <div>
                                <button class="btn btn-success me-2" onclick="showAddCompanyModal()">
                                    <i class="fas fa-plus me-2"></i> إضافة شركة جديدة
                                </button>
                                <button class="btn btn-info" onclick="showCategoriesModal()">
                                    <i class="fas fa-tags me-2"></i> إدارة الفئات
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>الشركة</th>
                                            <th>الفئة</th>
                                            <th>القسم الفرعي</th>
                                            <th>العمولة</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="companiesTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">جاري التحميل...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم الزبائن -->
                <div id="customers" class="admin-section">
                    <div class="action-buttons">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4><i class="fas fa-address-book me-2"></i> الزبائن</h4>
                            <button class="btn btn-success" onclick="showAddCustomerModal()">
                                <i class="fas fa-plus me-2"></i> إضافة زبون جديد
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>رقم الهاتف</th>
                                            <th>الاسم</th>
                                            <th>الجوال</th>
                                            <th>الشركة</th>
                                            <th>ملاحظات</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="customersTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">جاري التحميل...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم طلبات التسديد -->
                <div id="inquiryRequests" class="admin-section">
                    <div class="action-buttons">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4><i class="fas fa-credit-card me-2"></i> طلبات التسديد</h4>
                            <button class="btn btn-primary" onclick="refreshPaymentRequests()">
                                <i class="fas fa-sync me-2"></i> تحديث
                            </button>
                        </div>
                        <!-- أدوات البحث والفلترة -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="paymentRequestsSearch" 
                                           placeholder="البحث في الطلبات...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-control" id="paymentRequestsStatusFilter">
                                    <option value="">جميع الحالات</option>
                                    <option value="pending">قيد الانتظار</option>
                                    <option value="approved">مقبول</option>
                                    <option value="rejected">مرفوض</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearSearchFilters()">
                                    <i class="fas fa-times me-2"></i> مسح
                                </button>
                            </div>
                            <div class="col-md-3">
                                <div class="text-muted small text-center" id="requestsStats">
                                    <i class="fas fa-info-circle"></i> الإحصائيات
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-phone"></i> رقم الهاتف</th>
                                            <th><i class="fas fa-user"></i> اسم الزبون</th>
                                            <th><i class="fas fa-building"></i> الشركة</th>
                                            <th><i class="fas fa-money-bill"></i> المبلغ</th>
                                            <th><i class="fas fa-info-circle"></i> الحالة</th>
                                            <th><i class="fas fa-calendar"></i> التاريخ</th>
                                            <th><i class="fas fa-user-tie"></i> المستخدم</th>
                                            <th><i class="fas fa-cogs"></i> الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentRequestsTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">جاري التحميل...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم إدارة الإشعارات -->
                <div id="adminNotifications" class="admin-section">
                    <div class="action-buttons">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4><i class="fas fa-bell me-2"></i> إدارة الإشعارات</h4>
                            <div>
                                <button class="btn btn-primary me-2" onclick="showBroadcastNotificationModal()">
                                    <i class="fas fa-bullhorn me-2"></i> إشعار جماعي
                                </button>
                                <button class="btn btn-success" onclick="refreshNotificationsDirectly()">
                                    <i class="fas fa-sync me-2"></i> تحديث
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- إحصائيات الإشعارات -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card stats-card-modern h-100">
                                <div class="card-body text-center">
                                    <div class="stat-icon bg-primary bg-opacity-15 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                        <i class="fas fa-bell text-primary"></i>
                                    </div>
                                    <h5 class="mb-1 text-primary" id="totalNotifications">0</h5>
                                    <p class="text-muted mb-0 small">إجمالي الإشعارات</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card stats-card-modern h-100">
                                <div class="card-body text-center">
                                    <div class="stat-icon bg-warning bg-opacity-15 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                        <i class="fas fa-envelope text-warning"></i>
                                    </div>
                                    <h5 class="mb-1 text-warning" id="unreadNotifications">0</h5>
                                    <p class="text-muted mb-0 small">غير مقروءة</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card stats-card-modern h-100">
                                <div class="card-body text-center">
                                    <div class="stat-icon bg-success bg-opacity-15 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                        <i class="fas fa-calendar-day text-success"></i>
                                    </div>
                                    <h5 class="mb-1 text-success" id="todayNotifications">0</h5>
                                    <p class="text-muted mb-0 small">اليوم</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card stats-card-modern h-100">
                                <div class="card-body text-center">
                                    <div class="stat-icon bg-danger bg-opacity-15 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                        <i class="fas fa-exclamation-triangle text-danger"></i>
                                    </div>
                                    <h5 class="mb-1 text-danger" id="highPriorityNotifications">0</h5>
                                    <p class="text-muted mb-0 small">أولوية عالية</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- أدوات البحث والفلترة -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="notificationsSearch" placeholder="البحث في الإشعارات...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="notificationTypeFilter">
                                <option value="">جميع الأنواع</option>
                                <option value="info">معلومات</option>
                                <option value="success">نجاح</option>
                                <option value="warning">تحذير</option>
                                <option value="error">خطأ</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="notificationPriorityFilter">
                                <option value="">جميع الأولويات</option>
                                <option value="high">عالية</option>
                                <option value="normal">عادية</option>
                                <option value="low">منخفضة</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="notificationReadFilter">
                                <option value="">الكل</option>
                                <option value="read">مقروءة</option>
                                <option value="unread">غير مقروءة</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="btn-group w-100">
                                <button class="btn btn-outline-secondary" onclick="clearNotificationFilters()">
                                    <i class="fas fa-times me-1"></i> مسح
                                </button>
                                <button class="btn btn-outline-danger" onclick="showBulkActionsModal()">
                                    <i class="fas fa-cogs me-1"></i> عمليات متعددة
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- جدول الإشعارات المحدث -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAllNotifications" onchange="toggleSelectAllNotifications()">
                                        <label class="form-check-label fw-bold" for="selectAllNotifications">
                                            <i class="fas fa-check-square me-1 text-primary"></i>
                                            تحديد الكل
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div id="notificationsPaginationInfo" class="text-muted small"></div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadNotificationsAdmin()" title="تحديث الجدول">
                                        <i class="fas fa-sync me-1"></i> تحديث
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 70vh; overflow: auto;">
                                <table class="table table-hover table-striped mb-0" style="min-width: 1100px;">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th class="text-center align-middle" style="width: 50px; position: sticky; top: 0; z-index: 10;">
                                                <i class="fas fa-check text-primary"></i>
                                            </th>
                                            <th class="align-middle" style="width: 280px; position: sticky; top: 0; z-index: 10;">
                                                <i class="fas fa-bell me-1 text-warning"></i>
                                                الإشعار
                                            </th>
                                            <th class="align-middle" style="width: 130px; position: sticky; top: 0; z-index: 10;">
                                                <i class="fas fa-user me-1 text-info"></i>
                                                المستخدم
                                            </th>
                                            <th class="text-center align-middle" style="width: 90px; position: sticky; top: 0; z-index: 10;">
                                                <i class="fas fa-tag me-1 text-secondary"></i>
                                                النوع
                                            </th>
                                            <th class="text-center align-middle" style="width: 90px; position: sticky; top: 0; z-index: 10;">
                                                <i class="fas fa-flag me-1 text-danger"></i>
                                                الأولوية
                                            </th>
                                            <th class="text-center align-middle" style="width: 90px; position: sticky; top: 0; z-index: 10;">
                                                <i class="fas fa-eye me-1 text-success"></i>
                                                الحالة
                                            </th>
                                            <th class="align-middle" style="width: 130px; position: sticky; top: 0; z-index: 10;">
                                                <i class="fas fa-calendar me-1 text-muted"></i>
                                                التاريخ
                                            </th>
                                            <th class="align-middle" style="width: 100px; position: sticky; top: 0; z-index: 10;">
                                                <i class="fas fa-user-tie me-1 text-dark"></i>
                                                المرسل
                                            </th>
                                            <th class="text-center align-middle" style="width: 130px; position: sticky; top: 0; z-index: 10;">
                                                <i class="fas fa-cogs me-1 text-primary"></i>
                                                الإجراءات
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="notificationsTableBody">
                                        <tr>
                                            <td colspan="9" class="text-center p-5">
                                                <div class="d-flex justify-content-center align-items-center">
                                                    <div class="spinner-border text-primary me-3" role="status">
                                                        <span class="visually-hidden">جاري التحميل...</span>
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold">جاري تحميل الإشعارات...</div>
                                                        <small class="text-muted">يرجى الانتظار</small>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-top">
                            <!-- التنقل بين الصفحات المحدث -->
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div id="notificationsPaginationInfoBottom" class="text-muted small">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span>معلومات التنقل</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <nav aria-label="تنقل الإشعارات">
                                        <ul class="pagination justify-content-end mb-0 pagination-sm" id="notificationsPagination">
                                            <!-- سيتم إضافة أزرار التنقل هنا -->
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم الإعدادات -->
                <div id="settings" class="admin-section">
                    <div class="action-buttons">
                        <h4><i class="fas fa-cog me-2"></i> الإعدادات</h4>
                    </div>

                    <!-- إعدادات الموقع -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-cogs me-2"></i> إعدادات الموقع</h5>
                        </div>
                        <div class="card-body">
                            <form id="siteSettingsForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">اسم الموقع</label>
                                            <input type="text" class="form-control" id="siteName" value="نظام تسديد الفواتير">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">حالة الموقع</label>
                                            <select class="form-control" id="maintenanceMode">
                                                <option value="false">يعمل بشكل طبيعي</option>
                                                <option value="true">تحت الصيانة</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">نص الإعلان</label>
                                    <textarea class="form-control" id="announcement" rows="3">مرحباً بكم في نظام تسديد فواتير نظام تسديد الفواتير</textarea>
                                </div>
                                <div class="mb-3" id="maintenanceReasonSection" style="display: none;">
                                    <label class="form-label">مدة الاغلاق</label>
                                    <textarea class="form-control" id="maintenanceReason" rows="2" placeholder="سبب إيقاف الموقع مؤقتاً..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary me-2" onclick="saveSiteSettings()">
                                        <i class="fas fa-save me-2"></i> حفظ الإعدادات
                                    </button>
                                    <button type="button" class="btn btn-success me-2" onclick="createBackup()">
                                        <i class="fas fa-download me-2"></i> إنشاء نسخة احتياطية
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- النسخ الاحتياطية -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-archive me-2"></i> النسخ الاحتياطية</h5>
                            <button type="button" class="btn btn-outline-success" onclick="showUploadBackupModal()">
                                <i class="fas fa-upload me-2"></i> رفع نسخة احتياطية
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>اسم الملف</th>
                                            <th>الحجم</th>
                                            <th>تاريخ الإنشاء</th>
                                            <th>المنشئ</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="backupsTableBody">
                                        <tr>
                                            <td colspan="5" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">جاري التحميل...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- جميع النماذج المنبثقة (Modals) -->
    
    <!-- Modal تفاصيل الإشعار -->
    <div class="modal fade" id="notificationDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-bell me-2"></i>
                        تفاصيل الإشعار
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="notificationDetailsBody">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                        <div class="mt-2">جاري تحميل التفاصيل...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal العمليات المتعددة للإشعارات -->
    <div class="modal fade" id="bulkActionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-cogs me-2"></i>
                        العمليات المتعددة
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="selectedCount">تم تحديد 0 إشعار</span>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">اختر العملية المطلوبة:</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="bulkAction" id="markReadAction" value="mark_read">
                            <label class="form-check-label" for="markReadAction">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                تعليم كمقروءة
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulkAction" id="deleteAction" value="delete">
                            <label class="form-check-label" for="deleteAction">
                                <i class="fas fa-trash text-danger me-2"></i>
                                حذف الإشعارات
                            </label>
                        </div>
                    </div>
                    
                    <div class="alert alert-danger" id="deleteWarning" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>تحذير:</strong> سيتم حذف الإشعارات المحددة نهائياً ولا يمكن التراجع عن هذا الإجراء.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </button>
                    <button type="button" class="btn btn-primary" onclick="executeBulkAction()">
                        <i class="fas fa-check me-1"></i> تنفيذ العملية
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal إرسال إشعار جماعي -->
    <div class="modal fade" id="broadcastNotificationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-bullhorn me-2"></i>
                        إرسال إشعار جماعي
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="broadcastNotificationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-heading me-1"></i>
                                        عنوان الإشعار *
                                    </label>
                                    <input type="text" class="form-control" id="broadcastTitle" required placeholder="أدخل عنوان الإشعار">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-users me-1"></i>
                                        المستهدفون
                                    </label>
                                    <select class="form-control" id="broadcastTarget">
                                        <option value="all">جميع المستخدمين</option>
                                        <option value="active">المستخدمون النشطون فقط</option>
                                        <option value="admins">المديرون فقط</option>
                                        <option value="users">المستخدمون العاديون فقط</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        نوع الإشعار
                                    </label>
                                    <select class="form-control" id="broadcastType">
                                        <option value="info">معلومات</option>
                                        <option value="success">نجاح</option>
                                        <option value="warning">تحذير</option>
                                        <option value="error">خطأ</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-flag me-1"></i>
                                        الأولوية
                                    </label>
                                    <select class="form-control" id="broadcastPriority">
                                        <option value="normal">عادية</option>
                                        <option value="high">عالية</option>
                                        <option value="low">منخفضة</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-comment me-1"></i>
                                محتوى الإشعار *
                            </label>
                            <textarea class="form-control" id="broadcastMessage" rows="4" required placeholder="أدخل محتوى الإشعار..."></textarea>
                            <div class="form-text">يمكنك استخدام أسطر متعددة وعلامات الترقيم</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </button>
                    <button type="button" class="btn btn-primary" onclick="sendBroadcastNotification()">
                        <i class="fas fa-paper-plane me-1"></i> إرسال الإشعار
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal أساسي لتفاصيل الطلب -->
    <div class="modal fade" id="requestDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تفاصيل الطلب</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="requestDetailsBody">
                    <!-- سيتم تحميل التفاصيل هنا -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <div id="requestActions">
                        <!-- أزرار الإجراءات ستظهر هنا -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal إضافة/تعديل مستخدم -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">إضافة مستخدم جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">

                        <!-- معلومات أساسية -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i> المعلومات الأساسية</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label"><i class="fas fa-user me-1"></i> الاسم *</label>
                                            <input type="text" class="form-control" id="userName" required placeholder="أدخل اسم المستخدم">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label"><i class="fas fa-phone me-1"></i> رقم الجوال *</label>
                                            <input type="text" class="form-control" id="userPhone" required placeholder="09XXXXXXXX">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-lock me-1"></i> كلمة المرور</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="userPassword" placeholder="أدخل كلمة مرور جديدة">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('userPassword', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        اتركها فارغة في حالة التعديل للاحتفاظ بكلمة المرور الحالية
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- إعدادات الحساب -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-cog me-2"></i> إعدادات الحساب</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label"><i class="fas fa-wallet me-1 text-warning"></i> الرصيد (ل.س)</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-coins"></i>
                                                </span>
                                                <input type="number" class="form-control" id="userBalance" value="0" step="0.01" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label"><i class="fas fa-toggle-on me-1 text-info"></i> حالة الحساب</label>
                                            <select class="form-control" id="userStatus">
                                                <option value="1">✅ نشط ومفعل</option>
                                                <option value="0">❌ معطل ومحجوب</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label class="form-label"><i class="fas fa-user-tag me-1 text-primary"></i> نوع المستخدم</label>
                                            <select class="form-control" id="userRole">
                                                <option value="user">👤 مستخدم عادي</option>
                                                <option value="admin">👑 مدير النظام</option>
                                            </select>
                                            <small class="text-muted">
                                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                                تغيير نوع المستخدم سيؤثر على صلاحياته في النظام
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- معلومات إضافية للتعديل -->
                        <div id="editUserInfo" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i> معلومات إضافية</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">
                                                <strong>تاريخ الإنشاء:</strong> <span id="userCreatedAt">-</span>
                                            </small>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">
                                                <strong>معرف المستخدم:</strong> <span id="userIdDisplay">-</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i> إلغاء
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveUser()">
                        <i class="fas fa-save me-2"></i> حفظ التعديلات
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إضافة/تعديل شركة -->
    <div class="modal fade" id="companyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="companyModalTitle">إضافة شركة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="companyForm">
                        <input type="hidden" id="companyId">
                        <div class="mb-3">
                            <label class="form-label">اسم الشركة</label>
                            <input type="text" class="form-control" id="companyName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الفئة</label>
                            <select class="form-control" id="companyCategorySelect" required>
                                <option value="">اختر الفئة...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">القسم الفرعي</label>
                            <input type="text" class="form-control" id="companySubcategory" placeholder="مثال: خدمة مميزة، عادية، اقتصادية">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">العمولة (%)</label>
                            <input type="number" class="form-control" id="companyCommission" value="0" step="0.01" min="0" max="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الحالة</label>
                            <select class="form-control" id="companyStatus">
                                <option value="1">نشط</option>
                                <option value="0">معطل</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="saveCompany()">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إضافة/تعديل زبون -->
    <div class="modal fade" id="customerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalTitle">إضافة زبون جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId">
                        <div class="mb-3">
                            <label class="form-label">رقم الهاتف</label>
                            <input type="text" class="form-control" id="customerPhone" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الاسم</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">رقم الجوال</label>
                            <input type="text" class="form-control" id="customerMobile">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الشركة</label>
                            <select class="form-control" id="customerCompany">
                                <option value="">اختر الشركة...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ملاحظات</label>
                            <textarea class="form-control" id="customerNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"></button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomer()">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إدارة الفئات -->
    <div class="modal fade" id="categoriesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إدارة فئات الشركات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <button class="btn btn-success" onclick="showAddCategoryModal()">
                            <i class="fas fa-plus me-2"></i> إضافة فئة جديدة
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>الأيقونة</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTableBody">
                                <tr>
                                    <td colspan="4" class="text-center">جاري التحميل...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إضافة/تعديل فئة -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">إضافة فئة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        <div class="mb-3">
                            <label class="form-label">اسم الفئة</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">أيقونة الفئة</label>
                            <input type="text" class="form-control" id="categoryIcon">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الحالة</label>
                            <select class="form-control" id="categoryStatus">
                                <option value="1">نشط</option>
                                <option value="0">معطل</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"></button>
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إدارة الرصيد -->
    <div class="modal fade" id="balanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إدارة رصيد المستخدم</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="balanceUserId">
                    <div class="mb-3">
                        <label class="form-label">المستخدم</label>
                        <input type="text" class="form-control" id="balanceUserName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الرصيد الحالي (ل.س)</label>
                        <input type="text" class="form-control" id="currentBalance" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">المبلغ المضاف (ل.س) *</label>
                        <input type="number" class="form-control" id="balanceAmount" step="0.01" min="0" required placeholder="أدخل المبلغ المراد إضافته">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="balanceNotes" rows="3" placeholder="سبب إضافة الرصيد (اختياري)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveBalance()">
                        <i class="fas fa-plus me-2"></i>إضافة رصيد
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إرسال إشعار -->
    <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إرسال إشعار للمستخدم</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="notificationUserId">
                    <div class="mb-3">
                        <label class="form-label">المستخدم</label>
                        <input type="text" class="form-control" id="notificationUserName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">عنوان الإشعار *</label>
                        <input type="text" class="form-control" id="notificationTitle" required placeholder="أدخل عنوان الإشعار">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">نص الإشعار *</label>
                        <textarea class="form-control" id="notificationMessage" rows="4" required placeholder="أدخل محتوى الإشعار"></textarea>
                        <div class="form-text">سيتم إرسال الإشعار عبر النظام وتيليجرام إذا كان المستخدم مسجلاً</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveNotification()">
                        <i class="fas fa-paper-plane me-2"></i>إرسال الإشعار
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج رفع نسخة احتياطية -->
    <div class="modal fade" id="uploadBackupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">رفع نسخة احتياطية</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadBackupForm">
                        <div class="mb-3">
                            <label class="form-label">اختر ملف النسخة الاحتياطية (ZIP)</label>
                            <input type="file" class="form-control" id="backupFileInput" accept=".zip" required>
                            <div class="form-text">يجب أن يكون الملف بصيغة ZIP ويحتوي على نسخة احتياطية صحيحة</div>
                        </div>
                        <div id="uploadProgress" style="display: none;">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                                    جاري الرفع...
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-success" onclick="uploadBackup()">
                        <i class="fas fa-upload me-2"></i>رفع النسخة الاحتياطية
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج تأكيد الاستعادة -->
    <div class="modal fade" id="restoreConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        تحذير - استعادة نسخة احتياطية
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>تحذير:</strong> سيتم استبدال جميع البيانات الحالية بالنسخة الاحتياطية المحددة.
                    </div>
                    <p>هل أنت متأكد من استعادة النسخة الاحتياطية:</p>
                    <p class="fw-bold text-primary" id="restoreFilename"></p>
                    <p class="small text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        سيتم إنشاء نسخة احتياطية من الحالة الحالية تلقائياً قبل الاستعادة.
                    </p>
                    <input type="hidden" id="restoreBackupFilename">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmRestore()">
                        <i class="fas fa-undo me-2"></i>استعادة النسخة الاحتياطية
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج الإشعار الجماعي -->
    <div class="modal fade" id="broadcastNotificationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-bullhorn me-2"></i>
                        إرسال إشعار جماعي
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="broadcastNotificationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">عنوان الإشعار *</label>
                                    <input type="text" class="form-control" id="broadcastTitle" required placeholder="أدخل عنوان الإشعار">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">المستهدفون</label>
                                    <select class="form-control" id="broadcastTarget">
                                        <option value="all">جميع المستخدمين</option>
                                        <option value="active">المستخدمين النشطين فقط</option>
                                        <option value="admins">المديرين فقط</option>
                                        <option value="users">المستخدمين العاديين فقط</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">نوع الإشعار</label>
                                    <select class="form-control" id="broadcastType">
                                        <option value="info">معلومات</option>
                                        <option value="success">نجاح</option>
                                        <option value="warning">تحذير</option>
                                        <option value="error">خطأ</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">الأولوية</label>
                                    <select class="form-control" id="broadcastPriority">
                                        <option value="normal">عادية</option>
                                        <option value="high">عالية</option>
                                        <option value="low">منخفضة</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">نص الإشعار *</label>
                            <textarea class="form-control" id="broadcastMessage" rows="4" required placeholder="أدخل محتوى الإشعار"></textarea>
                            <div class="form-text">سيتم إرسال الإشعار عبر النظام وتيليجرام للمستخدمين المسجلين</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-primary" onclick="sendBroadcastNotification()">
                        <i class="fas fa-paper-plane me-2"></i>إرسال الإشعار
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج تفاصيل الإشعار -->
    <div class="modal fade" id="notificationDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-bell me-2"></i>
                        تفاصيل الإشعار
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="notificationDetailsBody">
                    <!-- سيتم تحميل التفاصيل هنا -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج العمليات المتعددة -->
    <div class="modal fade" id="bulkActionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cogs me-2"></i>
                        عمليات متعددة
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="selectedCount">تم تحديد 0 إشعار</span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">اختر العملية:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulkAction" id="bulkMarkRead" value="mark_read">
                            <label class="form-check-label" for="bulkMarkRead">
                                <i class="fas fa-check text-success me-2"></i>
                                تعليم كمقروءة
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulkAction" id="bulkDelete" value="delete">
                            <label class="form-check-label" for="bulkDelete">
                                <i class="fas fa-trash text-danger me-2"></i>
                                حذف الإشعارات
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-warning" id="deleteWarning" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>تحذير:</strong> لا يمكن التراجع عن عملية الحذف!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-primary" onclick="executeBulkAction()">
                        <i class="fas fa-check me-2"></i>تنفيذ العملية
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- تحميل المكتبات -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <script>
        // متغيرات عامة للصفحة الإدارية
        let adminCurrentRequestId = null;
        let adminPaymentRequests = [];
        let adminIsLoading = false;

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            console.log('تحميل لوحة الإدارة...');
            initializeAdminDashboard();
            updateLastLoginTime();
        });

        // تحديث الوقت
        function updateLastLoginTime() {
            const timeElement = document.getElementById('lastLoginTime');
            if (timeElement) {
                const now = new Date();
                timeElement.textContent = now.toLocaleString('ar-EG', {
                    calendar: 'gregory',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        // تهيئة لوحة الإدارة
        function initializeAdminDashboard() {
            try {
                // تحميل الإحصائيات الأساسية
                refreshStats();

                // إعداد مستمعي الأحداث
                setupEventListeners();

                console.log('تم تهيئة لوحة الإدارة بنجاح');
            } catch (error) {
                console.error('خطأ في تهيئة لوحة الإدارة:', error);
                showMessage('خطأ في تهيئة لوحة الإدارة', 'error');
            }
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // البحث في طلبات التسديد
            const searchInput = document.getElementById('paymentRequestsSearch');
            const statusFilter = document.getElementById('paymentRequestsStatusFilter');

            if (searchInput) {
                searchInput.addEventListener('input', debounce(searchPaymentRequests, 500));
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', searchPaymentRequests);
            }

            // مراقبة تغيير وضع الصيانة
            const maintenanceMode = document.getElementById('maintenanceMode');
            if (maintenanceMode) {
                maintenanceMode.addEventListener('change', function() {
                    const reasonSection = document.getElementById('maintenanceReasonSection');
                    if (reasonSection) {
                        reasonSection.style.display = this.value === 'true' ? 'block' : 'none';
                    }
                });
            }
        }

        // دالة تأخير البحث
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // إظهار الأقسام الإدارية
        function showAdminSection(sectionId, clickedElement) {
            try {
                console.log('إظهار القسم:', sectionId);

                // تحديث القائمة النشطة
                document.querySelectorAll('.admin-service-card').forEach(item => {
                    item.classList.remove('active');
                });
                if (clickedElement) {
                    clickedElement.classList.add('active');
                }

                // إخفاء جميع الأقسام
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.classList.remove('active');
                });

                // إظهار القسم المطلوب
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                    loadSectionData(sectionId);
                } else {
                    throw new Error(`القسم ${sectionId} غير موجود`);
                }

            } catch (error) {
                console.error(`خطأ في إظهار القسم ${sectionId}:`, error);
                showMessage(`خطأ في إظهار القسم المطلوب: ${error.message}`, 'error');
            }
        }

        // دالة التمرير التلقائي المحسن
        function smoothScrollToSection(sectionId) {
            const targetSection = document.getElementById(sectionId);
            if (!targetSection) return;

            // تحديد نوع التمرير حسب حجم الشاشة
            const isMobile = window.innerWidth <= 768;
            const isSmallMobile = window.innerWidth <= 576;

            setTimeout(() => {
                if (isMobile) {
                    // في الشاشات الصغيرة، التمرير لأعلى منطقة المحتوى الإداري
                    const adminContent = document.querySelector('.col-md-9');
                    if (adminContent) {
                        const offsetTop = adminContent.offsetTop;
                        const headerHeight = document.querySelector('.admin-header')?.offsetHeight || 0;
                        const finalOffset = Math.max(0, offsetTop - (isSmallMobile ? 10 : 20));

                        window.scrollTo({
                            top: finalOffset,
                            behavior: 'smooth'
                        });
                    }
                } else {
                    // في الشاشات الكبيرة، التمرير للقسم مباشرة
                    targetSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                }
            }, isMobile ? 300 : 200);
        }

        // تحميل بيانات القسم
        async function loadSectionData(sectionId) {
            if (adminIsLoading) return;

            try {
                adminIsLoading = true;

                switch (sectionId) {
                    case 'adminMain':
                        await refreshStats();
                        break;
                    case 'users':
                        await loadUsers();
                        break;
                    case 'companies':
                        await loadCompaniesAdmin();
                        break;
                    case 'customers':
                        await loadCustomers();
                        break;
                    case 'inquiryRequests':
                        await loadPaymentRequests();
                        break;
                    case 'adminNotifications':
                        console.log('تحميل إدارة الإشعارات...');
                        // التأكد من وجود الدوال في النطاق العام
                        if (typeof loadNotificationsAdmin === 'function') {
                            await loadNotificationsAdmin();
                        } else {
                            console.error('دالة loadNotificationsAdmin غير موجودة');
                            // تحميل مباشر كحل بديل
                            await loadNotificationsDirectly();
                        }
                        
                        if (typeof loadNotificationsStats === 'function') {
                            await loadNotificationsStats();
                        } else {
                            console.error('دالة loadNotificationsStats غير موجودة');
                            // تحميل مباشر كحل بديل
                            await loadNotificationsStatsDirectly();
                        }
                        break;
                    case 'settings':
                        await loadSiteSettingsAdmin();
                        await loadBackups();
                        break;
                }

                // تنفيذ التمرير بعد تحميل البيانات
                smoothScrollToSection(sectionId);

            } catch (error) {
                console.error(`خطأ في تحميل بيانات القسم ${sectionId}:`, error);
                showMessage(`خطأ في تحميل بيانات القسم: ${error.message}`, 'error');
            } finally {
                adminIsLoading = false;
            }
        }

        // تحديث جميع البيانات
        function refreshAllData() {
            const currentSection = document.querySelector('.admin-section.active');
            if (currentSection) {
                loadSectionData(currentSection.id);
            }
            refreshStats();
        }

        // دالة إظهار/إخفاء كلمة المرور
        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');

            if (input && icon) {
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }
        }

        // جميع الدوال الأخرى من الملف الأصلي
        // (تم الاحتفاظ بجميع الوظائف الإدارية الموجودة)

        // تحديث الإحصائيات
        async function refreshStats() {
            try {
                const response = await fetch('/api/admin-stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateStatsDisplay(stats);
                } else {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
            } catch (error) {
                console.error('خطأ في تحميل الإحصائيات:', error);
                // عرض قيم افتراضية في حالة الخطأ
                updateStatsDisplay({
                    users_count: 0,
                    successful: 0,
                    pending: 0,
                    rejected: 0
                });
            }
        }

        // تحديث عرض الإحصائيات
        function updateStatsDisplay(stats) {
            const elements = {
                usersCount: document.getElementById('adminUsersCount'),
                successful: document.getElementById('adminSuccessful'),
                pending: document.getElementById('adminPending'),
                rejected: document.getElementById('adminRejected')
            };

            Object.keys(elements).forEach(key => {
                if (elements[key]) {
                    const value = stats[key.replace('Count', '_count')] || stats[key] || 0;
                    elements[key].textContent = value;
                }
            });
        }

        // دوال مساعدة للرسائل
        function showMessage(message, type = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';

            const iconClass = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-triangle',
                'warning': 'fas fa-exclamation-circle',
                'info': 'fas fa-info-circle'
            }[type] || 'fas fa-info-circle';

            // إزالة الرسائل الموجودة
            document.querySelectorAll('.custom-alert').forEach(alert => alert.remove());

            // إنشاء الرسالة الجديدة
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed custom-alert`;
            alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 400px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);';
            alertDiv.innerHTML = `
                <i class="${iconClass} me-2"></i>${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;

            document.body.appendChild(alertDiv);

            // إزالة تلقائية بعد 5 ثوان
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // تحميل المستخدمين وجميع الدوال الأخرى
        // (يتم الاحتفاظ بجميع الدوال الموجودة في الملف الأصلي)

        async function loadUsers() {
            const tableBody = document.getElementById('usersTableBody');
            showTableLoading(tableBody, 6, 'جاري تحميل المستخدمين...');

            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                } else {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
            } catch (error) {
                console.error('خطأ في تحميل المستخدمين:', error);
                showTableError(tableBody, 6, error.message, 'loadUsers()');
            }
        }

        // عرض المستخدمين
        function displayUsers(users) {
            const tableBody = document.getElementById('usersTableBody');
            if (!tableBody) return;

            if (!users || users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد مستخدمين</td></tr>';
                return;
            }

            let html = '';
            users.forEach(user => {
                const statusBadge = user.is_active ?
                    '<span class="badge bg-success">نشط</span>' :
                    '<span class="badge bg-danger">معطل</span>';
                const roleBadge = user.role === 'admin' ?
                    '<span class="badge bg-primary">مدير</span>' :
                    '<span class="badge bg-secondary">مستخدم</span>';

                // تنظيف اسم المستخدم لتجنب مشاكل في JavaScript
                const safeName = user.name.replace(/'/g, "\\'").replace(/"/g, '\\"');

                html += `
                    <tr data-user-id="${user.id}">
                        <td>
                            <span class="text-primary fw-bold user-name-clickable"
                                  onclick="editUser(${user.id}); event.stopPropagation();"
                                  style="cursor: pointer;"
                                  title="اضغط لتعديل البيانات">
                                <i class="fas fa-user me-2"></i>
                                ${user.name}
                            </span>
                        </td>
                        <td>
                            <span class="text-muted">
                                <i class="fas fa-phone me-1"></i>
                                ${user.phone}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-${user.balance >= 0 ? 'success' : 'danger'} bg-opacity-15 text-${user.balance >= 0 ? 'success' : 'danger'}">
                                <i class="fas fa-coins me-1"></i>
                                ${user.balance} ل.س
                            </span>
                        </td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editUser(${user.id})" title="تعديل البيانات">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="manageUserBalance(${user.id}, '${safeName}', ${user.balance})" title="إدارة الرصيد">
                                    <i class="fas fa-wallet"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="sendUserNotification(${user.id}, '${safeName}')" title="إرسال إشعار">
                                    <i class="fas fa-bell"></i>
                                </button>
                                ${user.role !== 'admin' ? `
                                    <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="حذف المستخدم">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : '<span class="badge bg-warning text-dark small">محمي</span>'}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        // تحميل طلبات التسديد
        async function loadPaymentRequests() {
            const tableBody = document.getElementById('paymentRequestsTableBody');
            showTableLoading(tableBody, 8, 'جاري تحميل طلبات التسديد...');

            try {
                const response = await fetch('/api/payment-requests');
                if (response.ok) {
                    adminPaymentRequests = await response.json();
                    displayPaymentRequests(adminPaymentRequests);
                    updateRequestsStatistics();
                } else {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
            } catch (error) {
                console.error('خطأ في تحميل طلبات التسديد:', error);
                showTableError(tableBody, 8, error.message, 'loadPaymentRequests()');
            }
        }

        // تحديث طلبات التسديد
        function refreshPaymentRequests() {
            loadPaymentRequests();
        }

        // عرض طلبات التسديد
        function displayPaymentRequests(requests) {
            const tableBody = document.getElementById('paymentRequestsTableBody');
            if (!tableBody) return;

            // تطبيق الفلتر والبحث
            const searchTerm = document.getElementById('paymentRequestsSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('paymentRequestsStatusFilter')?.value || '';

            let filteredRequests = requests;
            if (searchTerm || statusFilter) {
                filteredRequests = requests.filter(request => {
                    const matchesSearch = !searchTerm ||
                        (request.phone_number && request.phone_number.toLowerCase().includes(searchTerm)) ||
                        (request.customer_name && request.customer_name.toLowerCase().includes(searchTerm)) ||
                        (request.company_name && request.company_name.toLowerCase().includes(searchTerm));

                    const matchesStatus = !statusFilter || request.status === statusFilter;

                    return matchesSearch && matchesStatus;
                });
            }

            if (!filteredRequests || filteredRequests.length === 0) {
                const message = searchTerm || statusFilter ? 'لا توجد نتائج تطابق البحث' : 'لا توجد طلبات تسديد';
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="alert alert-info d-inline-block">
                                <i class="fas fa-info-circle"></i> ${message}
                                ${(searchTerm || statusFilter) ? `
                                    <br>
                                    <button class="btn btn-sm btn-outline-info mt-2" onclick="clearSearchFilters()">
                                        <i class="fas fa-times"></i> مسح الفلاتر
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            filteredRequests.forEach((request) => {
                const statusBadge = `<span class="badge bg-${getStatusBadgeClass(request.status)}">${getStatusText(request.status)}</span>`;
                const rowClass = request.status === 'pending' ? 'table-warning' : '';

                html += `
                    <tr class="request-row ${rowClass}" style="cursor: pointer;" onclick="showRequestDetails(${request.id})">
                        <td>${request.phone_number || 'غير محدد'}</td>
                        <td>${request.customer_name || 'غير محدد'}</td>
                        <td>${request.company_name || 'غير محدد'}</td>
                        <td>
                            ${request.amount ? `${request.amount} ل.س` : '<span class="text-warning">غير محدد</span>'}
                        </td>
                        <td>${statusBadge}</td>
                        <td>${formatDate(request.created_at)}</td>
                        <td>${request.user_name || 'غير محدد'}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                ${request.status === 'pending' ? `
                                    <button type="button" class="btn btn-success btn-sm"
                                            onclick="event.stopPropagation(); handleRequestAction(${request.id}, 'approve')"
                                            title="موافقة">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm"
                                            onclick="event.stopPropagation(); handleRequestAction(${request.id}, 'reject')"
                                            title="رفض">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                                <button type="button" class="btn btn-info btn-sm"
                                        onclick="event.stopPropagation(); showRequestDetails(${request.id})"
                                        title="التفاصيل">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        // إظهار تفاصيل الطلب
        async function showRequestDetails(requestId) {
            try {
                adminCurrentRequestId = requestId;
                showLoadingOverlay('جاري تحميل تفاصيل الطلب...');

                const response = await fetch(`/api/payment-requests/${requestId}`);
                if (response.ok) {
                    const request = await response.json();
                    displayRequestDetailsModal(request);
                } else if (response.status === 404) {
                    showMessage('الطلب غير موجود', 'error');
                } else {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
            } catch (error) {
                console.error('خطأ في تحميل تفاصيل الطلب:', error);
                showMessage('خطأ في تحميل تفاصيل الطلب', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // عرض تفاصيل الطلب في مودال
        function displayRequestDetailsModal(request) {
            const modalBody = document.getElementById('requestDetailsBody');
            const actionsContainer = document.getElementById('requestActions');

            if (!modalBody) return;

            const statusText = getStatusText(request.status);
            const statusClass = getStatusBadgeClass(request.status);

            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>معلومات الزبون:</h6>
                        <p><strong>الاسم:</strong> ${request.customer_name || '-'}</p>
                        <p><strong>رقم الهاتف:</strong> ${request.phone_number || '-'}</p>
                        <p><strong>رقم الجوال:</strong> ${request.mobile_number || '-'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>معلومات الخدمة:</h6>
                        <p><strong>الشركة:</strong> ${request.company_name || '-'}</p>
                        <p><strong>الفئة:</strong> ${request.category_name || '-'}</p>
                        <p><strong>المبلغ:</strong> ${request.amount || 0} ل.س</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <p><strong>الحالة:</strong> <span class="badge bg-${statusClass}">${statusText}</span></p>
                        <p><strong>تاريخ الإنشاء:</strong> ${formatDate(request.created_at)}</p>
                        ${request.approved_at ? `<p><strong>تاريخ المعالجة:</strong> ${formatDate(request.approved_at)}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <p><strong>المستخدم:</strong> ${request.user_name || '-'}</p>
                        ${request.notes ? `<p><strong>ملاحظات:</strong> ${request.notes}</p>` : ''}
                        ${request.staff_notes ? `<p><strong>ملاحظة الموظف:</strong> ${request.staff_notes}</p>` : ''}
                    </div>
                </div>
            `;

            // أزرار الإجراءات
            if (actionsContainer) {
                let actionsHtml = '';
                if (request.status === 'pending') {
                    actionsHtml = `
                        <button type="button" class="btn btn-success me-2" onclick="handleRequestAction(${request.id}, 'approve')">
                            <i class="fas fa-check"></i> موافقة
                        </button>
                        <button type="button" class="btn btn-danger" onclick="handleRequestAction(${request.id}, 'reject')">
                            <i class="fas fa-times"></i> رفض
                        </button>
                    `;
                }
                actionsContainer.innerHTML = actionsHtml;
            }

            const modal = new bootstrap.Modal(document.getElementById('requestDetailsModal'));
            modal.show();
        }

        // معالجة إجراءات الطلب
        async function handleRequestAction(requestId, action) {
            if (!requestId || !action) return;

            try {
                let url, method, body, confirmMessage;

                if (action === 'approve') {
                    url = `/api/payment-requests/${requestId}/approve`;
                    method = 'POST';
                    confirmMessage = 'هل أنت متأكد من الموافقة على هذا الطلب؟';
                } else if (action === 'reject') {
                    const reason = prompt('يرجى إدخال سبب الرفض:', 'لم يتم استيفاء الشروط المطلوبة');
                    if (reason === null) return;

                    url = `/api/payment-requests/${requestId}/reject`;
                    method = 'POST';
                    body = JSON.stringify({ reason: reason || 'غير محدد' });
                    confirmMessage = 'هل أنت متأكد من رفض هذا الطلب؟';
                }

                if (!confirm(confirmMessage)) return;

                showLoadingOverlay('جاري معالجة الطلب...');

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: body
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message || 'تم معالجة الطلب بنجاح', 'success');

                    // إغلاق المودال
                    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('requestDetailsModal'));
                    if (detailsModal) {
                        detailsModal.hide();
                    }

                    // إعادة تحميل البيانات
                    await loadPaymentRequests();
                    await refreshStats();
                } else {
                    showMessage(result.error || 'خطأ في معالجة الطلب', 'error');
                }
            } catch (error) {
                console.error('خطأ في معالجة الطلب:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // البحث في طلبات التسديد
        function searchPaymentRequests() {
            if (adminPaymentRequests.length > 0) {
                displayPaymentRequests(adminPaymentRequests);
            }
        }

        // مسح فلاتر البحث
        function clearSearchFilters() {
            const searchInput = document.getElementById('paymentRequestsSearch');
            const statusFilter = document.getElementById('paymentRequestsStatusFilter');

            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';

            if (adminPaymentRequests.length > 0) {
                displayPaymentRequests(adminPaymentRequests);
            }
        }

        // ===== دوال مساعدة =====
        // تعديل إحصائيات المعاملات
        function updateRequestsStatistics() {
            const statsElement = document.getElementById('requestsStats');
            if (statsElement && adminPaymentRequests.length > 0) {
                const pending = adminPaymentRequests.filter(r => r.status === 'pending').length;
                const approved = adminPaymentRequests.filter(r => r.status === 'approved').length;
                const rejected = adminPaymentRequests.filter(r => r.status === 'rejected').length;

                statsElement.innerHTML = `
                    <small class="text-muted">
                        <i class="fas fa-clock text-warning"></i> قيد الانتظار: ${pending} |
                        <i class="fas fa-check text-success"></i> مقبول: ${approved} |
                        <i class="fas fa-times text-danger"></i> مرفوض: ${rejected}
                    </small>
                `;
            }
        }

        // دوال مساعدة
        function showTableLoading(tableBody, colspan, message) {
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${colspan}" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                            <div class="mt-2">${message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function showTableError(tableBody, colspan, message, retryFunction) {
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${colspan}" class="text-center">
                            <div class="alert alert-danger d-inline-block">
                                <i class="fas fa-exclamation-triangle"></i> ${message}
                                <br>
                                <button class="btn btn-sm btn-outline-danger mt-2" onclick="${retryFunction}">
                                    <i class="fas fa-redo"></i> إعادة المحاولة
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function showLoadingOverlay(message = 'جاري التحميل...') {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.className = 'loading-overlay';
                overlay.innerHTML = `
                    <div class="text-center text-white">
                        <div class="spinner-border mb-3" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                        <div>${message}</div>
                    </div>
                `;
                document.body.appendChild(overlay);
            } else {
                overlay.style.display = 'flex';
                overlay.querySelector('div:last-child').textContent = message;
            }
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'pending': 'warning',
                'approved': 'success',
                'rejected': 'danger'
            };
            return classes[status] || 'secondary';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'قيد الانتظار',
                'approved': 'مقبول',
                'rejected': 'مرفوض'
            };
            return texts[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return '';

            // إنشاء كائن التاريخ
            const date = new Date(dateString);

            // إضافة 3 ساعات لتصحيح التوقيت
            date.setHours(date.getHours() + 3);

            // تنسيق التاريخ بالصيغة الميلادية العربية
            return date.toLocaleString('ar-EG', {
                calendar: 'gregory', // التقويم الميلادي
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
                timeZone: 'Asia/Damascus' // توقيت دمشق
            });
        }

        // تحميل الشركات في لوحة الإدارة
        async function loadCompaniesAdmin() {
            const tableBody = document.getElementById('companiesTableBody');
            showTableLoading(tableBody, 6, 'جاري تحميل الشركات...');

            try {
                const response = await fetch('/api/companies');
                if (response.ok) {
                    const companies = await response.json();
                    console.log('تم تحميل الشركات:', companies.length);
                    displayCompaniesAdmin(companies);
                } else {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
            } catch (error) {
                console.error('خطأ في تحميل الشركات:', error);
                showTableError(tableBody, 6, error.message, 'loadCompaniesAdmin()');
            }
        }

        // عرض الشركات في لوحة الإدارة
        function displayCompaniesAdmin(companies) {
            const tableBody = document.getElementById('companiesTableBody');
            if (!tableBody) return;

            if (!companies || companies.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد شركات</td></tr>';
                return;
            }

            let html = '';
            companies.forEach(company => {
                const statusBadge = company.is_active ?
                    '<span class="badge bg-success">نشط</span>' :
                    '<span class="badge bg-danger">معطل</span>';

                html += `
                    <tr>
                        <td>
                            <i class="${company.category_icon || 'fas fa-building'}"></i>
                            ${company.name}
                        </td>
                        <td>${company.category_name || 'غير محدد'}</td>
                        <td>${company.subcategory || '-'}</td>
                        <td>${company.commission}%</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editCompany(${company.id})" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteCompany(${company.id})" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        // تحميل الزبائن
        async function loadCustomers() {
            const tableBody = document.getElementById('customersTableBody');
            showTableLoading(tableBody, 6, 'جاري تحميل الزبائن...');

            try {
                const response = await fetch('/api/customers');
                if (response.ok) {
                    const customers = await response.json();
                    console.log('تم تحميل الزبائن:', customers.length);
                    displayCustomers(customers);
                } else {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
            } catch (error) {
                console.error('خطأ في تحميل الزبائن:', error);
                showTableError(tableBody, 6, error.message, 'loadCustomers()');
            }

        }

        // عرض الزبائن
        function displayCustomers(customers) {
            const tableBody = document.getElementById('customersTableBody');
            if (!tableBody) return;

            if (!customers || customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد زبائن</td></tr>';
                return;
            }

            let html = '';
            customers.forEach(customer => {
                html += `
                    <tr>
                        <td>${customer.phone_number}</td>
                        <td>${customer.name}</td>
                        <td>${customer.mobile_number || '-'}</td>
                        <td>${customer.company_name}</td>
                        <td>${customer.notes || '-'}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editCustomer(${customer.id})" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteCustomer(${customer.id})" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        async function loadSiteSettingsAdmin() {
            try {
                const response = await fetch('/api/site-settings');
                if (response.ok) {
                    const settings = await response.json();
                    console.log('تم تحميل الإعدادات');
                } else {
                    throw new Error('فشل في تحميل الإعدادات');
                }
            } catch (error) {
                console.error('خطأ في تحميل الإعدادات:', error);
            }
        }

        async function loadBackups() {
            try {
                const response = await fetch('/api/backups');
                if (response.ok) {
                    const backups = await response.json();
                    console.log('تم تحميل النسخ الاحتياطية:', backups.length);
                } else {
                    throw new Error('فشل في تحميل النسخ الاحتياطية');
                }
            } catch (error) {
                console.error('خطأ في تحميل النسخ الاحتياطية:', error);
            }
        }

        // دوال التحميل المباشرة للإشعارات (حل احتياطي)
        async function loadNotificationsDirectly() {
            try {
                console.log('تحميل الإشعارات مباشرة...');
                showTableLoading(document.getElementById('notificationsTableBody'), 9, 'جاري تحميل الإشعارات...');
                
                const searchTerm = document.getElementById('notificationsSearch')?.value || '';
                const typeFilter = document.getElementById('notificationTypeFilter')?.value || '';
                const priorityFilter = document.getElementById('notificationPriorityFilter')?.value || '';
                const readFilter = document.getElementById('notificationReadFilter')?.value || '';
                
                const params = new URLSearchParams({
                    page: 1,
                    per_page: 20
                });
                
                if (searchTerm) params.append('search', searchTerm);
                if (typeFilter) params.append('type', typeFilter);
                if (priorityFilter) params.append('priority', priorityFilter);
                if (readFilter) params.append('read_status', readFilter);
                
                const response = await fetch(`/api/admin/notifications?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    displayNotificationsDirectly(data);
                    updateNotificationsPaginationDirectly(data);
                } else {
                    throw new Error('فشل في تحميل الإشعارات');
                }
            } catch (error) {
                console.error('خطأ في تحميل الإشعارات:', error);
                showTableError(document.getElementById('notificationsTableBody'), 9, error.message, 'loadNotificationsDirectly()');
            }
        }

        async function loadNotificationsStatsDirectly() {
            try {
                const response = await fetch('/api/admin/notifications/stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateNotificationsStatsDisplayDirectly(stats);
                }
            } catch (error) {
                console.error('خطأ في تحميل إحصائيات الإشعارات:', error);
            }
        }

        function displayNotificationsDirectly(data) {
            const tbody = document.getElementById('notificationsTableBody');
            if (!tbody) return;
            
            if (!data.notifications || data.notifications.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center">
                            <div class="p-4">
                                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                                <p class="text-muted">لا توجد إشعارات</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.notifications.map(notification => {
                const typeColors = {
                    'info': 'text-info',
                    'success': 'text-success',
                    'warning': 'text-warning',
                    'error': 'text-danger'
                };
                
                const priorityColors = {
                    'high': 'text-danger',
                    'normal': 'text-primary',
                    'low': 'text-secondary'
                };
                
                const typeIcons = {
                    'info': 'fa-info-circle',
                    'success': 'fa-check-circle',
                    'warning': 'fa-exclamation-triangle',
                    'error': 'fa-times-circle'
                };
                
                const priorityIcons = {
                    'high': 'fa-exclamation-circle',
                    'normal': 'fa-flag',
                    'low': 'fa-minus-circle'
                };
                
                return `
                    <tr class="${notification.is_read ? '' : 'table-warning'}" 
                        style="transition: all 0.3s ease;">
                        <td>
                            <input type="checkbox" class="notification-checkbox" 
                                   value="${notification.id}">
                        </td>
                        <td>
                            <div class="fw-bold">${notification.title}</div>
                            <div class="text-muted small text-truncate" style="max-width: 200px;">
                                ${notification.message}
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold">${notification.user_name || 'غير محدد'}</div>
                            <div class="text-muted small">${notification.user_phone || ''}</div>
                        </td>
                        <td>
                            <span class="badge bg-light ${typeColors[notification.type]}">
                                <i class="fas ${typeIcons[notification.type]} me-1"></i>
                                ${getNotificationTypeTextDirect(notification.type)}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-light ${priorityColors[notification.priority]}">
                                <i class="fas ${priorityIcons[notification.priority]} me-1"></i>
                                ${getNotificationPriorityTextDirect(notification.priority)}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${notification.is_read ? 'bg-success' : 'bg-warning'}">
                                <i class="fas ${notification.is_read ? 'fa-check' : 'fa-clock'} me-1"></i>
                                ${notification.is_read ? 'مقروء' : 'غير مقروء'}
                            </span>
                        </td>
                        <td>
                            <div class="small">${formatDate(notification.created_at)}</div>
                        </td>
                        <td>
                            <div class="small">${notification.sent_by_name}</div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" 
                                        onclick="showNotificationDetailsDirectly(${notification.id})"
                                        title="عرض التفاصيل">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-danger" 
                                        onclick="deleteNotificationDirectly(${notification.id})"
                                        title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateNotificationsPaginationDirectly(data) {
            const paginationInfo = document.getElementById('notificationsPaginationInfo');
            const pagination = document.getElementById('notificationsPagination');
            
            if (paginationInfo) {
                const start = (data.page - 1) * data.per_page + 1;
                const end = Math.min(data.page * data.per_page, data.total);
                paginationInfo.textContent = `عرض ${start}-${end} من ${data.total} إشعار`;
            }
            
            if (pagination && data.total_pages > 1) {
                pagination.innerHTML = '';
                
                // زر السابق
                if (data.page > 1) {
                    pagination.innerHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="loadNotificationsDirectly()">السابق</a>
                        </li>
                    `;
                }
                
                // أرقام الصفحات
                for (let i = Math.max(1, data.page - 2); i <= Math.min(data.total_pages, data.page + 2); i++) {
                    pagination.innerHTML += `
                        <li class="page-item ${i === data.page ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadNotificationsDirectly()">${i}</a>
                        </li>
                    `;
                }
                
                // زر التالي
                if (data.page < data.total_pages) {
                    pagination.innerHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="loadNotificationsDirectly()">التالي</a>
                        </li>
                    `;
                }
            }
        }

        function updateNotificationsStatsDisplayDirectly(stats) {
            const elements = {
                totalNotifications: document.getElementById('totalNotifications'),
                unreadNotifications: document.getElementById('unreadNotifications'),
                todayNotifications: document.getElementById('todayNotifications'),
                highPriorityNotifications: document.getElementById('highPriorityNotifications')
            };
            
            if (elements.totalNotifications) elements.totalNotifications.textContent = stats.total || 0;
            if (elements.unreadNotifications) elements.unreadNotifications.textContent = stats.unread || 0;
            if (elements.todayNotifications) elements.todayNotifications.textContent = stats.by_period?.today || 0;
            if (elements.highPriorityNotifications) elements.highPriorityNotifications.textContent = stats.by_priority?.high || 0;
        }

        function getNotificationTypeTextDirect(type) {
            const types = {
                'info': 'معلومات',
                'success': 'نجاح',
                'warning': 'تحذير',
                'error': 'خطأ'
            };
            return types[type] || 'معلومات';
        }

        function getNotificationPriorityTextDirect(priority) {
            const priorities = {
                'high': 'عالية',
                'normal': 'عادية',
                'low': 'منخفضة'
            };
            return priorities[priority] || 'عادية';
        }

        async function showNotificationDetailsDirectly(notificationId) {
            console.log('عرض تفاصيل الإشعار:', notificationId);
            showMessage('تفاصيل الإشعار متاحة قريباً', 'info');
        }

        async function deleteNotificationDirectly(notificationId) {
            if (!confirm('هل أنت متأكد من حذف هذا الإشعار؟')) return;
            
            try {
                const response = await fetch(`/api/admin/notifications/${notificationId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('تم حذف الإشعار بنجاح', 'success');
                    loadNotificationsDirectly();
                } else {
                    showMessage(result.error || 'فشل في حذف الإشعار', 'error');
                }
            } catch (error) {
                console.error('خطأ في حذف الإشعار:', error);
                showMessage('خطأ في حذف الإشعار', 'error');
            }
        }

        async function refreshNotificationsDirectly() {
            await loadNotificationsDirectly();
            await loadNotificationsStatsDirectly();
            showMessage('تم تحديث الإشعارات بنجاح', 'success');
        }

        // تحميل إحصائيات الإدارة
        async function loadAdminStats() {
            try {
                const response = await fetch('/api/admin-stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateStatsDisplay(stats);
                } else {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
            } catch (error) {
                console.error('خطأ في تحميل الإحصائيات:', error);
                // عرض قيم افتراضية في حالة الخطأ
                updateStatsDisplay({
                    users_count: 0,
                    successful: 0,
                    pending: 0,
                    rejected: 0
                });
            }
        }

        // تحميل إعدادات الموقع للإدارة
        async function loadSiteSettingsAdmin() {
            try {
                const response = await fetch('/api/site-settings');
                if (response.ok) {
                    const settings = await response.json();
                    console.log('تم تحميل إعدادات الموقع:', settings);

                    // ملء النموذج بالإعدادات المحملة
                    const siteNameField = document.getElementById('siteName');
                    const announcementField = document.getElementById('announcement');
                    const maintenanceModeField = document.getElementById('maintenanceMode');
                    const maintenanceReasonField = document.getElementById('maintenanceReason');

                    if (siteNameField) siteNameField.value = settings.site_name || 'نظام التسديد';
                    if (announcementField) announcementField.value = settings.announcement || 'مرحباً بكم في نظام تسديد الفواتير';
                    if (maintenanceModeField) {
                        maintenanceModeField.value = settings.is_maintenance ? 'true' : 'false';
                        // تحديث عرض قسم مدة الاغلاق
                        const reasonSection = document.getElementById('maintenanceReasonSection');
                        if (reasonSection) {
                            reasonSection.style.display = settings.is_maintenance ? 'block' : 'none';
                        }
                    }
                    if (maintenanceReasonField) maintenanceReasonField.value = settings.maintenance_reason || '';

                } else {
                    console.error('خطأ في تحميل الإعدادات:', response.status);
                    setDefaultSiteSettings();
                }
            } catch (error) {
                console.error('خطأ في تحميل إعدادات الموقع:', error);
                setDefaultSiteSettings();
            }
        }

        // تحديد القيم الافتراضية للإعدادات
        function setDefaultSiteSettings() {
            const siteNameField = document.getElementById('siteName');
            const announcementField = document.getElementById('announcement');
            const maintenanceModeField = document.getElementById('maintenanceMode');
            const maintenanceReasonField = document.getElementById('maintenanceReason');

            if (siteNameField) siteNameField.value = 'نظام التسديد';
            if (announcementField) announcementField.value = 'مرحباً بكم في نظام تسديد الفواتير';
            if (maintenanceModeField) maintenanceModeField.value = 'false';
            if (maintenanceReasonField) maintenanceReasonField.value = '';

            const reasonSection = document.getElementById('maintenanceReasonSection');
            if (reasonSection) {
                reasonSection.style.display = 'none';
            }
        }

        // حفظ إعدادات الموقع
        async function saveSiteSettings() {
            try {
                showLoadingOverlay('جاري حفظ الإعدادات...');

                // جمع البيانات من النموذج
                const siteName = document.getElementById('siteName')?.value?.trim() || '';
                const announcement = document.getElementById('announcement')?.value?.trim() || '';
                const maintenanceMode = document.getElementById('maintenanceMode')?.value || 'false';
                const maintenanceReason = document.getElementById('maintenanceReason')?.value?.trim() || '';

                // التحقق من البيانات
                if (!siteName) {
                    showMessage('يرجى إدخال اسم الموقع', 'error');
                    return;
                }

                if (!announcement) {
                    showMessage('يرجى إدخال نص الإعلان', 'error');
                    return;
                }

                // إعداد البيانات للإرسال
                const settingsData = {
                    site_name: siteName,
                    announcement: announcement,
                    is_maintenance: maintenanceMode === 'true',
                    maintenance_reason: maintenanceReason
                };

                console.log('إرسال البيانات:', settingsData);

                // إرسال الطلب
                const response = await fetch('/api/site-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingsData)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message || 'تم حفظ الإعدادات بنجاح', 'success');
                    console.log('تم حفظ الإعدادات بنجاح');
                } else {
                    showMessage(result.error || 'خطأ في حفظ الإعدادات', 'error');
                    console.error('خطأ في حفظ الإعدادات:', result);
                }

            } catch (error) {
                console.error('خطأ في حفظ الإعدادات:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // إنشاء نسخة احتياطية
        async function createBackup() {
            try {
                showLoadingOverlay('جاري إنشاء النسخة الاحتياطية...');

                const response = await fetch('/api/create-backup', {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`تم إنشاء النسخة الاحتياطية بنجاح: ${result.filename}`, 'success');
                    loadBackups(); // إعادة تحميل قائمة النسخ الاحتياطية
                } else {
                    showMessage(result.error || 'خطأ في إنشاء النسخة الاحتياطية', 'error');
                }

            } catch (error) {
                console.error('خطأ في إنشاء النسخة الاحتياطية:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // تحميل الفئات في القائمة المنسدلة
        async function loadCategoriesIntoSelect() {
            try {
                const response = await fetch('/api/categories');
                if (response.ok) {
                    const categories = await response.json();
                    const select = document.getElementById('companyCategorySelect');
                    
                    if (select) {
                        // مسح الخيارات الموجودة (عدا الخيار الافتراضي)
                        const defaultOption = select.querySelector('option[value=""]');
                        select.innerHTML = '';
                        if (defaultOption) {
                            select.appendChild(defaultOption);
                        } else {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'اختر الفئة...';
                            select.appendChild(option);
                        }
                        
                        // إضافة الفئات
                        categories.filter(cat => cat.is_active).forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            select.appendChild(option);
                        });
                    }
                } else {
                    console.error('خطأ في تحميل الفئات للقائمة المنسدلة');
                }
            } catch (error) {
                console.error('خطأ في تحميل الفئات:', error);
            }
        }

        // تحميل الشركات في القائمة المنسدلة لنموذج الزبون
        async function loadCompaniesIntoCustomerSelect() {
            try {
                const response = await fetch('/api/companies');
                if (response.ok) {
                    const companies = await response.json();
                    const select = document.getElementById('customerCompany');
                    
                    if (select) {
                        // مسح الخيارات الموجودة (عدا الخيار الافتراضي)
                        const defaultOption = select.querySelector('option[value=""]');
                        select.innerHTML = '';
                        if (defaultOption) {
                            select.appendChild(defaultOption);
                        } else {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'اختر الشركة...';
                            select.appendChild(option);
                        }
                        
                        // إضافة الشركات النشطة فقط
                        companies.filter(company => company.is_active).forEach(company => {
                            const option = document.createElement('option');
                            option.value = company.id; // استخدام معرف الشركة
                            option.textContent = company.name;
                            select.appendChild(option);
                        });
                    }
                } else {
                    console.error('خطأ في تحميل الشركات للقائمة المنسدلة');
                }
            } catch (error) {
                console.error('خطأ في تحميل الشركات:', error);
            }
        }

        // تحميل النسخ الاحتياطية
        async function loadBackups() {
            try {
                const response = await fetch('/api/backups');
                if (response.ok) {
                    const backups = await response.json();
                    console.log('تم تحميل النسخ الاحتياطية:', backups.length);
                    displayBackups(backups);                } else {
                    console.error('خطأ في تحميل النسخ الاحتياطية:', response.status);
                }
            } catch (error) {
                console.error('خطأ في تحميل النسخ الاحتياطية:', error);
            }
        }

        // عرض النسخ الاحتياطية
        function displayBackups(backups) {
            const tableBody = document.getElementById('backupsTableBody');
            if (!tableBody) return;

            if (!backups || backups.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">لا توجد نسخ احتياطية</td></tr>';
                return;
            }

            let html = '';
            backups.forEach(backup => {
                const fileSize = backup.file_size ? (backup.file_size / 1024 / 1024).toFixed(2) + ' MB' : 'غير محدد';
                const createdAt = formatDate(backup.created_at);

                html += `
                    <tr>
                        <td>${backup.filename}</td>
                        <td>${fileSize}</td>
                        <td>${createdAt}</td>
                        <td>${backup.created_by || 'غير محدد'}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="/api/download-backup/${backup.filename}" class="btn btn-outline-primary" title="تحميل">
                                    <i class="fas fa-download"></i>
                                </a>
                                <button class="btn btn-outline-warning" onclick="showRestoreConfirm('${backup.filename}')" title="استعادة">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteBackup(${backup.id})" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        // إظهار تأكيد الاستعادة
        function showRestoreConfirm(filename) {
            document.getElementById('restoreFilename').textContent = filename;
            document.getElementById('restoreBackupFilename').value = filename;

            const modal = new bootstrap.Modal(document.getElementById('restoreConfirmModal'));
            modal.show();
        }

        // تأكيد الاستعادة
        async function confirmRestore() {
            const filename = document.getElementById('restoreBackupFilename').value;

            try {
                showLoadingOverlay('جاري استعادة النسخة الاحتياطية...');

                const response = await fetch(`/api/restore-backup/${filename}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message || 'تم استعادة النسخة الاحتياطية بنجاح', 'success');

                    // إغلاق المودال
                    const modal = bootstrap.Modal.getInstance(document.getElementById('restoreConfirmModal'));
                    if (modal) modal.hide();

                    // إعادة تحميل الصفحة بعد فترة قصيرة
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showMessage(result.error || 'خطأ في استعادة النسخة الاحتياطية', 'error');
                }

            } catch (error) {
                console.error('خطأ في استعادة النسخة الاحتياطية:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // حذف نسخة احتياطية
        async function deleteBackup(backupId) {
            if (!confirm('هل أنت متأكد من حذف هذه النسخة الاحتياطية؟')) {
                return;
            }

            try {
                showLoadingOverlay('جاري حذف النسخة الاحتياطية...');

                const response = await fetch(`/api/backups/${backupId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('تم حذف النسخة الاحتياطية بنجاح', 'success');
                    loadBackups(); // إعادة تحميل القائمة
                } else {
                    showMessage(result.error || 'خطأ في حذف النسخة الاحتياطية', 'error');
                }

            } catch (error) {
                console.error('خطأ في حذف النسخة الاحتياطية:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // إظهار مودال رفع نسخة احتياطية
        function showUploadBackupModal() {
            const modal = new bootstrap.Modal(document.getElementById('uploadBackupModal'));
            modal.show();
        }

        // رفع نسخة احتياطية
        async function uploadBackup() {
            const fileInput = document.getElementById('backupFileInput');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('يرجى اختيار ملف أولاً', 'error');
                return;
            }

            if (!file.name.endsWith('.zip')) {
                showMessage('يجب أن يكون الملف بصيغة ZIP', 'error');
                return;
            }

            try {
                const progressDiv = document.getElementById('uploadProgress');
                if (progressDiv) progressDiv.style.display = 'block';

                const formData = new FormData();
                formData.append('backup_file', file);

                const response = await fetch('/api/upload-backup', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('تم رفع النسخة الاحتياطية بنجاح', 'success');

                    // إغلاق المودال
                    const modal = bootstrap.Modal.getInstance(document.getElementById('uploadBackupModal'));
                    if (modal) modal.hide();

                    // مسح النموذج وإعادة تحميل القائمة
                    document.getElementById('uploadBackupForm').reset();
                    loadBackups();
                } else {
                    showMessage(result.error || 'خطأ في رفع النسخة الاحتياطية', 'error');
                }

            } catch (error) {
                console.error('خطأ في رفع النسخة الاحتياطية:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                const progressDiv = document.getElementById('uploadProgress');
                if (progressDiv) progressDiv.style.display = 'none';
            }
        }

        function showAddUserModal() {
            // إعادة تعيين النموذج
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';

            // تعيين القيم الافتراضية
            document.getElementById('userBalance').value = '0';
            document.getElementById('userRole').value = 'user';
            document.getElementById('userStatus').value = '1';

            // إخفاء المعلومات الإضافية
            const editInfo = document.getElementById('editUserInfo');
            if (editInfo) {
                editInfo.style.display = 'none';
            }

            // تغيير عنوان المودال
            document.getElementById('userModalTitle').textContent = 'إضافة مستخدم جديد';

            // إظهار المودال
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }

        async function showAddCompanyModal() {
            document.getElementById('companyModalTitle').textContent = 'إضافة شركة جديدة';
            document.getElementById('companyForm').reset();
            document.getElementById('companyId').value = '';
            
            // تحميل الفئات في القائمة المنسدلة
            await loadCategoriesIntoSelect();
            
            const modal = new bootstrap.Modal(document.getElementById('companyModal'));
            modal.show();
        }

        async function showAddCustomerModal() {
            document.getElementById('customerModalTitle').textContent = 'إضافة زبون جديد';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            
            // تحميل الشركات في القائمة المنسدلة
            await loadCompaniesIntoCustomerSelect();
            
            const modal = new bootstrap.Modal(document.getElementById('customerModal'));
            modal.show();
        }

        // تعديل شركة
        async function editCompany(companyId) {
            try {
                const response = await fetch(`/api/companies/${companyId}`);
                if (response.ok) {
                    const company = await response.json();

                    // تحميل الفئات أولاً
                    await loadCategoriesIntoSelect();

                    // ملء النموذج ببيانات الشركة
                    document.getElementById('companyId').value = company.id;
                    document.getElementById('companyName').value = company.name;
                    document.getElementById('companyCategorySelect').value = company.category_id || '';
                    document.getElementById('companySubcategory').value = company.subcategory || '';
                    document.getElementById('companyCommission').value = company.commission || 0;
                    document.getElementById('companyStatus').value = company.is_active ? '1' : '0';

                    // تغيير عنوان المودال
                    document.getElementById('companyModalTitle').textContent = 'تعديل الشركة';

                    // إظهار المودال
                    const modal = new bootstrap.Modal(document.getElementById('companyModal'));
                    modal.show();
                } else {
                    showMessage('خطأ في تحميل بيانات الشركة', 'error');
                }
            } catch (error) {
                console.error('خطأ في تحميل بيانات الشركة:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // حذف شركة
        async function deleteCompany(companyId) {
            if (!confirm('هل أنت متأكد من حذف هذه الشركة؟')) {
                return;
            }

            try {
                const response = await fetch(`/api/companies/${companyId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('تم حذف الشركة بنجاح', 'success');
                    loadCompaniesAdmin(); // إعادة تحميل قائمة الشركات
                } else {
                    showMessage(result.error || 'خطأ في حذف الشركة', 'error');
                }
            } catch (error) {
                console.error('خطأ في حذف الشركة:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // تعديل زبون
        async function editCustomer(customerId) {
            try {
                const response = await fetch(`/api/customers/${customerId}`);
                if (response.ok) {
                    const customer = await response.json();

                    // تحميل الشركات أولاً
                    await loadCompaniesIntoCustomerSelect();

                    // ملء النموذج ببيانات الزبون
                    document.getElementById('customerId').value = customer.id;
                    document.getElementById('customerPhone').value = customer.phone_number;
                    document.getElementById('customerName').value = customer.name;
                    document.getElementById('customerMobile').value = customer.mobile_number || '';
                    document.getElementById('customerCompany').value = customer.company_id || ''; // استخدام معرف الشركة
                    document.getElementById('customerNotes').value = customer.notes || '';

                    // تغيير عنوان المودال
                    document.getElementById('customerModalTitle').textContent = 'تعديل الزبون';

                    // إظهار المودال
                    const modal = new bootstrap.Modal(document.getElementById('customerModal'));
                    modal.show();
                } else {
                    showMessage('خطأ في تحميل بيانات الزبون', 'error');
                }
            } catch (error) {
                console.error('خطأ في تحميل بيانات الزبون:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // حذف زبون
        async function deleteCustomer(customerId) {
            if (!confirm('هل أنت متأكد من حذف هذا الزبون؟')) {
                return;
            }

            try {
                const response = await fetch(`/api/customers/${customerId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('تم حذف الزبون بنجاح', 'success');
                    loadCustomers(); // إعادة تحميل قائمة الزبائن
                } else {
                    showMessage(result.error || 'خطأ في حذف الزبون', 'error');
                }
            } catch (error) {
                console.error('خطأ في حذف الزبون:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // حفظ بيانات الشركة
        async function saveCompany() {
            const companyId = document.getElementById('companyId').value;
            const name = document.getElementById('companyName').value.trim();
            const categoryId = document.getElementById('companyCategorySelect').value;
            const subcategory = document.getElementById('companySubcategory').value.trim();
            const commission = parseFloat(document.getElementById('companyCommission').value) || 0;
            const status = parseInt(document.getElementById('companyStatus').value);

            // التحقق من صحة البيانات
            if (!name) {
                showMessage('اسم الشركة مطلوب', 'error');
                return;
            }

            if (!categoryId) {
                showMessage('الفئة مطلوبة', 'error');
                return;
            }

            try {
                showLoadingOverlay(companyId ? 'جاري تحديث الشركة...' : 'جاري إضافة الشركة...');

                const companyData = {
                    name: name,
                    category_id: categoryId,
                    subcategory: subcategory,
                    commission: commission,
                    is_active: status
                };

                const url = companyId ? `/api/companies/${companyId}` : '/api/companies';
                const method = companyId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(companyData)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message || 'تم حفظ الشركة بنجاح', 'success');
                    
                    // إغلاق المودال
                    const modal = bootstrap.Modal.getInstance(document.getElementById('companyModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // إعادة تحميل الشركات
                    await loadCompaniesAdmin();
                } else {
                    showMessage(result.error || 'خطأ في حفظ الشركة', 'error');
                }

            } catch (error) {
                console.error('خطأ في حفظ الشركة:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // حفظ بيانات الزبون
        async function saveCustomer() {
            const customerId = document.getElementById('customerId').value;
            const phone = document.getElementById('customerPhone').value.trim();
            const name = document.getElementById('customerName').value.trim();
            const mobile = document.getElementById('customerMobile').value.trim();
            const companySelect = document.getElementById('customerCompany');
            const companyId = companySelect.value;
            const notes = document.getElementById('customerNotes').value.trim();

            // التحقق من صحة البيانات
            if (!phone) {
                showMessage('رقم الهاتف مطلوب', 'error');
                return;
            }

            if (!name) {
                showMessage('اسم الزبون مطلوب', 'error');
                return;
            }

            try {
                showLoadingOverlay(customerId ? 'جاري تحديث الزبون...' : 'جاري إضافة الزبون...');

                const customerData = {
                    phone_number: phone,
                    name: name,
                    mobile_number: mobile,
                    company_id: companyId, // إرسال معرف الشركة بدلاً من الاسم
                    notes: notes
                };

                const url = customerId ? `/api/customers/${customerId}` : '/api/customers';
                const method = customerId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message || 'تم حفظ الزبون بنجاح', 'success');
                    
                    // إغلاق المودال
                    const modal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // إعادة تحميل قائمة الزبائن
                    await loadCustomers();
                } else {
                    showMessage(result.error || 'خطأ في حفظ الزبون', 'error');
                }

            } catch (error) {
                console.error('خطأ في حفظ الزبون:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // إظهار مودال إدارة الفئات
        async function showCategoriesModal() {
            try {
                showLoadingOverlay('جاري تحميل الفئات...');
                
                // تحميل الفئات
                const response = await fetch('/api/categories');
                if (response.ok) {
                    const categories = await response.json();
                    displayCategories(categories);
                    
                    // إظهار المودال
                    const modal = new bootstrap.Modal(document.getElementById('categoriesModal'));
                    modal.show();
                } else {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }
            } catch (error) {
                console.error('خطأ في تحميل الفئات:', error);
                showMessage('خطأ في تحميل الفئات', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // عرض الفئات في الجدول
        function displayCategories(categories) {
            const tableBody = document.getElementById('categoriesTableBody');
            if (!tableBody) return;

            if (!categories || categories.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">لا توجد فئات</td></tr>';
                return;
            }

            let html = '';
            categories.forEach(category => {
                const statusBadge = category.is_active ?
                    '<span class="badge bg-success">نشط</span>' :
                    '<span class="badge bg-danger">معطل</span>';

                html += `
                    <tr>
                        <td>
                            <i class="${category.icon || 'fas fa-tag'} me-2"></i>
                            ${category.name}
                        </td>
                        <td>
                            <i class="${category.icon || 'fas fa-tag'}"></i>
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editCategory(${category.id})" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteCategory(${category.id})" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        // إظهار مودال إضافة فئة جديدة
        function showAddCategoryModal() {
            // إعادة تعيين النموذج
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            
            // تعيين القيم الافتراضية
            document.getElementById('categoryIcon').value = 'fas fa-building';
            document.getElementById('categoryStatus').value = '1';
            
            // تغيير عنوان المودال
            document.getElementById('categoryModalTitle').textContent = 'إضافة فئة جديدة';
            
            // إغلاق مودال الفئات أولاً
            const categoriesModal = bootstrap.Modal.getInstance(document.getElementById('categoriesModal'));
            if (categoriesModal) {
                categoriesModal.hide();
            }
            
            // إظهار مودال إضافة الفئة بعد إغلاق المودال السابق
            setTimeout(() => {
                const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
                modal.show();
            }, 300);
        }

        // تعديل فئة موجودة
        async function editCategory(categoryId) {
            try {
                showLoadingOverlay('جاري تحميل بيانات الفئة...');
                
                const response = await fetch(`/api/categories/${categoryId}`);
                if (response.ok) {
                    const category = await response.json();
                    
                    // ملء النموذج ببيانات الفئة
                    document.getElementById('categoryId').value = category.id;
                    document.getElementById('categoryName').value = category.name;
                    document.getElementById('categoryIcon').value = category.icon || 'fas fa-building';
                    document.getElementById('categoryStatus').value = category.is_active ? '1' : '0';
                    
                    // تغيير عنوان المودال
                    document.getElementById('categoryModalTitle').textContent = 'تعديل الفئة';
                    
                    // إغلاق مودال الفئات أولاً
                    const categoriesModal = bootstrap.Modal.getInstance(document.getElementById('categoriesModal'));
                    if (categoriesModal) {
                        categoriesModal.hide();
                    }
                    
                    // إظهار مودال التعديل بعد إغلاق المودال السابق
                    setTimeout(() => {
                        const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
                        modal.show();
                    }, 300);
                    
                } else {
                    showMessage('خطأ في تحميل بيانات الفئة', 'error');
                }
            } catch (error) {
                console.error('خطأ في تحميل بيانات الفئة:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // حذف فئة
        async function deleteCategory(categoryId) {
            if (!confirm('هل أنت متأكد من حذف هذه الفئة؟\n\nتحذير: قد يؤثر هذا على الشركات المرتبطة بهذه الفئة')) {
                return;
            }

            try {
                showLoadingOverlay('جاري حذف الفئة...');
                
                const response = await fetch(`/api/categories/${categoryId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('تم حذف الفئة بنجاح', 'success');
                    
                    // إعادة تحميل الفئات في المودال
                    const categoriesModal = bootstrap.Modal.getInstance(document.getElementById('categoriesModal'));
                    if (categoriesModal) {
                        const categoriesResponse = await fetch('/api/categories');
                        if (categoriesResponse.ok) {
                            const categories = await categoriesResponse.json();
                            displayCategories(categories);
                        }
                    }
                    
                    // إعادة تحميل الشركات إذا كان القسم نشط
                    const companiesSection = document.getElementById('companies');
                    if (companiesSection && companiesSection.classList.contains('active')) {
                        await loadCompaniesAdmin();
                    }
                } else {
                    showMessage(result.error || 'خطأ في حذف الفئة', 'error');
                }
            } catch (error) {
                console.error('خطأ في حذف الفئة:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // حفظ بيانات الفئة (إضافة أو تعديل)
        async function saveCategory() {
            const categoryId = document.getElementById('categoryId').value;
            const name = document.getElementById('categoryName').value.trim();
            const icon = document.getElementById('categoryIcon').value.trim();
            const status = parseInt(document.getElementById('categoryStatus').value);

            // التحقق من صحة البيانات
            if (!name) {
                showMessage('اسم الفئة مطلوب', 'error');
                return;
            }

            if (!icon) {
                showMessage('أيقونة الفئة مطلوبة', 'error');
                return;
            }

            try {
                showLoadingOverlay(categoryId ? 'جاري تحديث الفئة...' : 'جاري إضافة الفئة...');

                const categoryData = {
                    name: name,
                    icon: icon,
                    is_active: status
                };

                const url = categoryId ? `/api/categories/${categoryId}` : '/api/categories';
                const method = categoryId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(categoryData)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message || 'تم حفظ الفئة بنجاح', 'success');
                    
                    // إغلاق مودال التعديل/الإضافة
                    const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // إعادة فتح مودال الفئات وتحديث البيانات
                    setTimeout(async () => {
                        try {
                            const categoriesResponse = await fetch('/api/categories');
                            if (categoriesResponse.ok) {
                                const categories = await categoriesResponse.json();
                                displayCategories(categories);
                                
                                const categoriesModal = new bootstrap.Modal(document.getElementById('categoriesModal'));
                                categoriesModal.show();
                            }
                        } catch (error) {
                            console.error('خطأ في إعادة تحميل الفئات:', error);
                        }
                    }, 300);
                    
                    // إعادة تحميل الشركات إذا كان القسم نشط
                    const companiesSection = document.getElementById('companies');
                    if (companiesSection && companiesSection.classList.contains('active')) {
                        await loadCompaniesAdmin();
                    }
                } else {
                    showMessage(result.error || 'خطأ في حفظ الفئة', 'error');
                }

            } catch (error) {
                console.error('خطأ في حفظ الفئة:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // تعديل مستخدم - محسن مع معلومات إضافية
        async function editUser(userId) {
            console.log('تعديل بيانات المستخدم:', userId);

            if (!userId) {
                showMessage('معرف المستخدم غير صحيح', 'error');
                return;
            }

            try {
                showLoadingOverlay('جاري تحميل بيانات المستخدم...');

                const response = await fetch(`/api/users/${userId}`);
                if (response.ok) {
                    const user = await response.json();
                    console.log('تم تحميل بيانات المستخدم:', user);

                    // التأكد من وجود النموذج
                    const userModal = document.getElementById('userModal');
                    const userForm = document.getElementById('userForm');

                    if (!userModal || !userForm) {
                        throw new Error('نموذج المستخدم غير موجود');
                    }

                    // إعادة تعيين النموذج أولاً
                    userForm.reset();

                    // ملء النموذج ببيانات المستخدم
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userName').value = user.name || '';
                    document.getElementById('userPhone').value = user.phone || '';
                    document.getElementById('userPassword').value = ''; // اتركها فارغة للأمان
                    document.getElementById('userRole').value = user.role || 'user';
                    document.getElementById('userBalance').value = parseFloat(user.balance) || 0;
                    document.getElementById('userStatus').value = user.is_active ? '1' : '0';

                    // إظهار المعلومات الإضافية للتعديل
                    const editInfo = document.getElementById('editUserInfo');
                    if (editInfo) {
                        editInfo.style.display = 'block';
                        const createdAtElement = document.getElementById('userCreatedAt');
                        const idDisplayElement = document.getElementById('userIdDisplay');

                        if (createdAtElement) {
                            createdAtElement.textContent = formatDate(user.created_at) || 'غير محدد';
                        }
                        if (idDisplayElement) {
                            idDisplayElement.textContent = user.id || 'غير محدد';
                        }
                    }

                    // تغيير عنوان المودال
                    const modalTitle = document.getElementById('userModalTitle');
                    if (modalTitle) {
                        modalTitle.textContent = 'تعديل بيانات المستخدم: ' + user.name;
                    }

                    // إخفاء Loading أولاً
                    hideLoadingOverlay();

                    // إظهار المودال
                    const modal = new bootstrap.Modal(userModal, {
                        backdrop: 'static',
                        keyboard: false
                    });
                    modal.show();

                    // التركيز على حقل الاسم
                    setTimeout(() => {
                        const nameField = document.getElementById('userName');
                        if (nameField) {
                            nameField.focus();
                        }
                    }, 500);

                    console.log('تم فتح نموذج التعديل بنجاح');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessage(errorData.error || `خطأ في تحميل بيانات المستخدم (${response.status})`, 'error');
                }
            } catch (error) {
                console.error('خطأ في تحميل بيانات المستخدم:', error);
                if (error.name === 'AbortError') {
                    showMessage('انتهت مهلة الطلب، يرجى المحاولة مرة أخرى', 'error');
                } else if (error.message.includes('Failed to fetch')) {
                    showMessage('فشل في الاتصال بالخادم، تحقق من الاتصال', 'error');
                } else {
                    showMessage('خطأ غير متوقع في تحميل البيانات: ' + error.message, 'error');
                }
            } finally {
                hideLoadingOverlay();
            }
        }

        // حذف مستخدم
        async function deleteUser(userId) {
            // الحصول على اسم المستخدم من الجدول
            const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
            const userName = userRow ? userRow.querySelector('.user-name-clickable').textContent.trim() : 'المستخدم';
            
            if (!confirm(`هل أنت متأكد من حذف المستخدم "${userName}"؟\n\nتحذير: هذا الإجراء لا يمكن التراجع عنه وسيؤدي إلى حذف جميع بيانات المستخدم!`)) {
                return;
            }

            try {
                showLoadingOverlay('جاري حذف المستخدم...');

                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`تم حذف المستخدم "${userName}" بنجاح`, 'success');
                    await loadUsers(); // إعادة تحميل قائمة المستخدمين
                } else {
                    showMessage(result.error || 'خطأ في حذف المستخدم', 'error');
                }
            } catch (error) {
                console.error('خطأ في حذف المستخدم:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        function manageUserBalance(id, name, balance) {
            // ملء نموذج إدارة الرصيد
            document.getElementById('balanceUserId').value = id;
            document.getElementById('balanceUserName').value = name;
            document.getElementById('currentBalance').value = `${balance} ل.س`;
            document.getElementById('balanceAmount').value = '';
            document.getElementById('balanceNotes').value = '';

            const modal = new bootstrap.Modal(document.getElementById('balanceModal'));
            modal.show();
        }

        // حفظ بيانات المستخدم
        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const name = document.getElementById('userName').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            const role = document.getElementById('userRole').value;
            const balance = parseFloat(document.getElementById('userBalance').value) || 0;
            const status = parseInt(document.getElementById('userStatus').value);

            // التحقق من صحة البيانات
            if (!name) {
                showMessage('اسم المستخدم مطلوب', 'error');
                return;
            }

            if (!phone) {
                showMessage('رقم الجوال مطلوب', 'error');
                return;
            }

            if (!userId && !password) {
                showMessage('كلمة المرور مطلوبة للمستخدم الجديد', 'error');
                return;
            }

            if (password && password.length < 6) {
                showMessage('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                return;
            }

            if (balance < 0) {
                showMessage('الرصيد لا يمكن أن يكون سالباً', 'error');
                return;
            }

            try {
                showLoadingOverlay(userId ? 'جاري تحديث بيانات المستخدم...' : 'جاري إضافة المستخدم...');

                const userData = {
                    name: name,
                    phone: phone,
                    role: role,
                    balance: balance,
                    is_active: status
                };

                // إضافة كلمة المرور فقط إذا تم إدخالها
                if (password) {
                    userData.password = password;
                }

                const url = userId ? `/api/users/${userId}` : '/api/users';
                const method = userId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message || 'تم حفظ بيانات المستخدم بنجاح', 'success');
                    
                    // إغلاق المودال
                    const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // إعادة تحميل قائمة المستخدمين
                    await loadUsers();
                } else {
                    showMessage(result.error || 'خطأ في حفظ بيانات المستخدم', 'error');
                }

            } catch (error) {
                console.error('خطأ في حفظ بيانات المستخدم:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        async function sendUserNotification(id, name) {
            // ملء نموذج الإشعار
            document.getElementById('notificationUserId').value = id;
            document.getElementById('notificationUserName').value = name;
            document.getElementById('notificationTitle').value = '';
            document.getElementById('notificationMessage').value = '';

            const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
            modal.show();
        }

        // حفظ الرصيد
        async function saveBalance() {
            const userId = document.getElementById('balanceUserId').value;
            const amount = parseFloat(document.getElementById('balanceAmount').value);
            const notes = document.getElementById('balanceNotes').value.trim();

            if (!amount || amount <= 0) {
                showMessage('يرجى إدخال مبلغ صحيح', 'error');
                return;
            }

            try {
                showLoadingOverlay('جاري تحديث الرصيد...');

                const response = await fetch(`/api/users/${userId}/add-balance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount,
                        notes: notes
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message || 'تم تحديث الرصيد بنجاح', 'success');
                    
                    // إغلاق المودال
                    const modal = bootstrap.Modal.getInstance(document.getElementById('balanceModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // إعادة تحميل قائمة المستخدمين
                    await loadUsers();
                } else {
                    showMessage(result.error || 'خطأ في تحديث الرصيد', 'error');
                }

            } catch (error) {
                console.error('خطأ في تحديث الرصيد:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        // حفظ الإشعار
        async function saveNotification() {
            const userId = document.getElementById('notificationUserId').value;
            const title = document.getElementById('notificationTitle').value.trim();
            const message = document.getElementById('notificationMessage').value.trim();

            if (!title || !message) {
                showMessage('العنوان والرسالة مطلوبان', 'error');
                return;
            }

            try {
                showLoadingOverlay('جاري إرسال الإشعار...');

                const response = await fetch(`/api/users/${userId}/send-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        message: message
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message || 'تم إرسال الإشعار بنجاح', 'success');
                    
                    // إغلاق المودال
                    const modal = bootstrap.Modal.getInstance(document.getElementById('notificationModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // مسح النموذج
                    document.getElementById('notificationTitle').value = '';
                    document.getElementById('notificationMessage').value = '';
                } else {
                    showMessage(result.error || 'خطأ في إرسال الإشعار', 'error');
                }

            } catch (error) {
                console.error('خطأ في إرسال الإشعار:', error);
                showMessage('خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoadingOverlay();
            }
        }

        

        // التأكد من توفر جميع الدوال عالمياً
        window.showAdminSection = showAdminSection;
        window.refreshStats = refreshStats;
        window.refreshAllData = refreshAllData;
        window.togglePasswordVisibility = togglePasswordVisibility;

        window.displayUsers = displayUsers;
        window.loadUsers = loadUsers;

        console.log('تم تحميل لوحة الإدارة المحدثة بنجاح');
    </script>
</body>
</html>