
{% extends "base.html" %}

{% block title %}لوحة تحكم المستخدم - {{ session.user_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- شريط الحالة العلوي مع الإشعارات -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-gradient" style="background: linear-gradient(135deg, #4a90e2 0%, #3498db 100%);">
                <div class="card-body text-white">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-1">
                                <i class="fas fa-user-circle me-2"></i>
                                أهلاً وسهلاً، {{ session.user_name }}
                            </h4>
                            <p class="mb-0 opacity-75">
                                <i class="fas fa-clock me-1"></i>
                                آخر دخول: <span id="lastLoginTime">الآن</span>
                            </p>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="text-center">
                                <div class="small text-white-50">الرصيد الحالي</div>
                                <div class="h3 mb-0 text-white">
                                    <i class="fas fa-wallet me-2"></i>
                                    <span id="currentBalance">{{ session.user_balance }}</span> ل.س
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-end">
                            <div class="d-flex justify-content-end gap-3">
                                <!-- زر القائمة الجانبية -->
                                <button class="btn btn-outline-light" onclick="toggleSidebar()" id="sidebarToggle">
                                    <i class="fas fa-bars me-2"></i>
                                    القائمة
                                </button>
                                <!-- زر الإشعارات -->
                                <button class="btn btn-outline-light position-relative d-flex align-items-center" onclick="showSection('notifications')" title="الإشعارات">
                                    <i class="fas fa-bell me-2"></i>
                                    <span class="d-none d-md-inline">الإشعارات</span>
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
                                          id="notificationBadge" style="display: none; font-size: 11px; min-width: 18px; height: 18px; line-height: 1.4;">
                                        0
                                    </span>
                                </button>
                                <!-- زر تسجيل الخروج --></old_str>
                                <!-- زر تسجيل الخروج -->
                                <a href="/logout" class="btn btn-outline-light">
                                    <i class="fas fa-sign-out-alt me-2"></i>
                                    خروج
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- إعلان النظام -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-dismissible fade show" style="background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%); color: white; border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(139,0,0,0.3);">
                <div class="d-flex align-items-center">
                    <i class="fas fa-bullhorn fa-lg me-3"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 fw-bold">إعلان النظام</h6>
                        <div id="announcementText" style="white-space: pre-line; font-size: 14px;">مرحباً بكم في نظام تسديد الفواتير</div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <!-- خدمات التسديد السريع -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-credit-card me-2 text-primary"></i>
                            خدمات التسديد السريع
                        </h5>
                        <button class="btn btn-outline-info btn-sm" onclick="showSection('transactions')">
                            <i class="fas fa-history me-2"></i>
                            تاريخ المعاملات
                        </button>
                    </div>
                </div></old_str>
                <div class="card-body">
                    <div class="row g-3 justify-content-center">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="service-card-modern card h-100 border-0 shadow-sm" onclick="requestService('1', 'payment', 'تسديد فاتورة')">
                                <div class="card-body text-center p-4">
                                    <div class="service-icon bg-primary bg-opacity-10 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                        <i class="fas fa-money-bill-wave fa-2x text-primary"></i>
                                    </div>
                                    <h4 class="card-title mb-3">تسديد فاتورة</h4>
                                    <p class="card-text text-muted">تسديد فواتير جميع الشركات بسرعة وأمان</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- الإحصائيات السريعة -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 stats-card-modern">
                <div class="card-body text-center">
                    <div class="stat-icon bg-warning bg-opacity-10 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                        <i class="fas fa-clock fa-lg text-warning"></i>
                    </div>
                    <h3 class="mb-1 text-warning" id="pendingRequests">0</h3>
                    <p class="text-muted mb-0">طلبات قيد الانتظار</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 stats-card-modern">
                <div class="card-body text-center">
                    <div class="stat-icon bg-success bg-opacity-10 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                        <i class="fas fa-check-circle fa-lg text-success"></i>
                    </div>
                    <h3 class="mb-1 text-success" id="completedTransactions">0</h3>
                    <p class="text-muted mb-0">عمليات مكتملة</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 stats-card-modern">
                <div class="card-body text-center">
                    <div class="stat-icon bg-danger bg-opacity-10 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                        <i class="fas fa-times-circle fa-lg text-danger"></i>
                    </div>
                    <h3 class="mb-1 text-danger" id="rejectedRequests">0</h3>
                    <p class="text-muted mb-0">طلبات مرفوضة</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 stats-card-modern">
                <div class="card-body text-center">
                    <div class="stat-icon bg-info bg-opacity-10 rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                        <i class="fas fa-calendar-day fa-lg text-info"></i>
                    </div>
                    <h3 class="mb-1 text-info" id="todayTotal">0 ل.س</h3>
                    <p class="text-muted mb-0">إجمالي اليوم</p>
                </div>
            </div>
        </div>
    </div>

    <!-- صفحة المعاملات -->
    <div id="transactions" class="section-content" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">
                            <i class="fas fa-exchange-alt me-2 text-primary"></i>
                            معاملاتي
                        </h5>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadUserTransactions()">
                            <i class="fas fa-sync"></i> تحديث
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- فلاتر البحث -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="transactionSearch" placeholder="البحث برقم الهاتف أو اسم العميل">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="transactionStatus">
                            <option value="">جميع الحالات</option>
                            <option value="pending">قيد الانتظار</option>
                            <option value="approved">مقبول</option>
                            <option value="rejected">مرفوض</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="searchTransactions()">
                            <i class="fas fa-search"></i> بحث
                        </button>
                    </div>
                </div>

                <!-- جدول المعاملات -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>رقم الهاتف</th>
                                <th>اسم العميل</th>
                                <th>الشركة</th>
                                <th>الفئة</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                                <th>التاريخ</th>
                            </tr>
                        </thead>
                        <tbody id="userTransactionsTableBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- صفحة الإشعارات -->
    <div id="notifications" class="section-content" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">
                            <i class="fas fa-bell me-2 text-warning"></i>
                            الإشعارات
                        </h5>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-outline-warning btn-sm" onclick="markAllNotificationsRead()">
                            <i class="fas fa-check-double"></i> تعليم الكل كمقروء
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="notificationsContainer">
                    <div class="text-center p-4">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- القائمة الجانبية -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas">
    <div class="offcanvas-header bg-primary text-white">
        <h5 class="offcanvas-title">
            <i class="fas fa-user-circle me-2"></i>
            {{ session.user_name }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <!-- معلومات الحساب -->
        <div class="card border-0 m-3">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(45deg, #4a90e2, #3498db);">
                <h6 class="mb-0">
                    <i class="fas fa-user-cog me-2"></i>
                    معلومات الحساب
                </h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="avatar-circle bg-primary bg-opacity-10 rounded-circle mx-auto d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                        <i class="fas fa-user fa-xl text-primary"></i>
                    </div>
                </div>
                <div class="info-item mb-2">
                    <small class="text-muted">الاسم</small>
                    <div class="fw-bold">{{ session.user_name }}</div>
                </div>
                <div class="info-item mb-2">
                    <small class="text-muted">النوع</small>
                    <div>
                        {% if session.user_role == 'admin' %}
                            <span class="badge bg-danger">مدير النظام</span>
                        {% else %}
                            <span class="badge bg-primary">مستخدم</span>
                        {% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <small class="text-muted">الرصيد</small>
                    <div class="fw-bold text-success">{{ session.user_balance }} ل.س</div>
                </div>
            </div>
        </div>

        <!-- القائمة الرئيسية -->
        <div class="card border-0 m-3">
            <div class="card-header bg-white border-0 pb-0">
                <h6 class="text-muted mb-0">القائمة الرئيسية</h6>
            </div>
            <div class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action active border-0" onclick="showSection('mainServices'); closeSidebar();">
                    <i class="fas fa-home me-3 text-primary"></i>
                    الخدمات الرئيسية
                </a>
                <a href="#" class="list-group-item list-group-item-action border-0" onclick="showSection('transactions'); closeSidebar();">
                    <i class="fas fa-exchange-alt me-3 text-success"></i>
                    معاملاتي
                    <span class="badge bg-primary rounded-pill float-end" id="transactionsBadge">0</span>
                </a>
                <a href="#" class="list-group-item list-group-item-action border-0" onclick="showSection('notifications'); closeSidebar();">
                    <i class="fas fa-bell me-3 text-warning"></i>
                    الإشعارات
                    <span class="badge bg-danger rounded-pill float-end" id="sidebarNotificationBadge" style="display: none; font-size: 11px; min-width: 18px;">0</span>
                </a>
            </div>
            
            <div class="card-header bg-light border-0 pb-0 pt-3">
                <h6 class="text-muted mb-0">الإعدادات</h6>
            </div>
            <div class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action border-0" onclick="showAnnouncementModal(); closeSidebar();">
                    <i class="fas fa-bullhorn me-3 text-info"></i>
                    إعلان النظام
                </a>
                <a href="#" class="list-group-item list-group-item-action border-0" onclick="showChangePasswordModal(); closeSidebar();">
                    <i class="fas fa-key me-3 text-warning"></i>
                    تغيير كلمة المرور
                </a>
            </div>
        </div>
    </div>
</div>

<!-- نموذج طلب الخدمة -->
<div class="modal fade" id="serviceRequestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-gradient text-white" style="background: linear-gradient(45deg, #4a90e2, #3498db);">
                <h5 class="modal-title" id="serviceModalTitle">
                    <i class="fas fa-credit-card me-2"></i>
                    طلب تسديد جديد
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="serviceRequestForm">
                    <!-- رقم الهاتف والبحث -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="servicePhoneNumber" class="form-label">رقم هاتف العميل <span class="text-danger">*</span></label>
                            <div class="row g-2">
                                <div class="col-12 col-md-8">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-phone"></i>
                                        </span>
                                        <input type="tel" class="form-control" id="servicePhoneNumber" required 
                                               placeholder="أدخل رقم الهاتف" 
                                               onkeypress="handlePhoneKeyPress(event)">
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <button type="button" class="btn btn-primary w-100" id="searchCustomerBtn" onclick="searchExistingCustomer()">
                                        <i class="fas fa-search me-1"></i>
                                        <span class="d-none d-sm-inline">بحث عن العميل</span>
                                        <span class="d-sm-none">بحث</span>
                                    </button>
                                </div>
                            </div>
                            <div class="form-text text-muted small mt-2">
                                <i class="fas fa-info-circle"></i> 
                                يجب البحث عن الرقم أولاً لتفعيل باقي الحقول
                            </div>
                            <!-- رسالة حالة البحث -->
                            <div id="searchStatus" class="mt-2" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- باقي الحقول (معطلة في البداية) -->
                    <fieldset id="customerFieldsContainer" disabled>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="serviceCustomerName" class="form-label">اسم العميل <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="serviceCustomerName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="serviceMobileNumber" class="form-label">رقم الجوال</label>
                                <input type="tel" class="form-control" id="serviceMobileNumber" 
                                       placeholder="رقم الجوال (اختياري)">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="serviceCompanySelect" class="form-label">الشركة <span class="text-danger">*</span></label>
                                <select class="form-select" id="serviceCompanySelect" required onchange="updateServiceDetails()">
                                    <option value="">اختر الشركة</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="serviceAmount" class="form-label">المبلغ (ل.س) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-money-bill"></i>
                                    </span>
                                    <input type="number" class="form-control" id="serviceAmount" min="0" step="1" required>
                                    <span class="input-group-text">ل.س</span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-label">رصيدك الحالي</div>
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-wallet me-2"></i>
                                    <strong id="modalCurrentBalance">{{ session.user_balance }}</strong> ل.س
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="serviceNotes" class="form-label">ملاحظات</label>
                            <textarea class="form-control" id="serviceNotes" rows="3" 
                                      placeholder="أي ملاحظات إضافية..."></textarea>
                        </div>
                    </fieldset>
                    
                    <input type="hidden" id="serviceCategoryId">
                    <input type="hidden" id="serviceCompanyId">
                    <input type="hidden" id="serviceType">
                    <input type="hidden" id="customerSearched" value="false">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button type="button" class="btn btn-primary" onclick="submitServiceRequest()">
                    <i class="fas fa-paper-plane"></i> إرسال الطلب
                </button>
            </div>
        </div>
    </div>
</div>

<!-- نموذج تفاصيل المعاملة -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-receipt me-2"></i>
                    تفاصيل المعاملة
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="transactionDetailsBody">
                    <!-- سيتم ملء التفاصيل هنا -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
</div>

<!-- نموذج إعلان النظام -->
<div class="modal fade" id="announcementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-bullhorn me-2"></i>
                    إعلان النظام
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-bullhorn fa-3x text-info mb-3"></i>
                    <div id="announcementModalText" class="h5 text-dark" style="white-space: pre-line;">مرحباً بكم في نظام تسديد الفواتير</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
</div>

<!-- نموذج تغيير كلمة المرور -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>
                    تغيير كلمة المرور
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">كلمة المرور الحالية <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-lock"></i>
                            </span>
                            <input type="password" class="form-control" id="currentPassword" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('currentPassword', 'currentPasswordToggle')">
                                <i class="fas fa-eye" id="currentPasswordToggle"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">كلمة المرور الجديدة <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-key"></i>
                            </span>
                            <input type="password" class="form-control" id="newPassword" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('newPassword', 'newPasswordToggle')">
                                <i class="fas fa-eye" id="newPasswordToggle"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle text-info"></i>
                            يجب أن تكون كلمة المرور 6 أحرف على الأقل
                        </div>
                        <div id="passwordStrength" class="mt-2"></div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">تأكيد كلمة المرور الجديدة <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-check"></i>
                            </span>
                            <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('confirmPassword', 'confirmPasswordToggle')">
                                <i class="fas fa-eye" id="confirmPasswordToggle"></i>
                            </button>
                        </div>
                        <div id="passwordMatch" class="mt-2"></div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>تنبيه مهم:</strong> عند تغيير كلمة المرور، سيتم إنهاء جميع جلساتك النشطة في:
                        <ul class="mb-0 mt-2">
                            <li>الموقع الإلكتروني</li>
                            <li>بوت التليجرام</li>
                        </ul>
                        وستحتاج لتسجيل الدخول مرة أخرى في جميع الأجهزة.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button type="button" class="btn btn-warning" onclick="changePassword()" id="changePasswordBtn" disabled>
                    <i class="fas fa-save"></i> تغيير كلمة المرور
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// دوال القائمة الجانبية
function toggleSidebar() {
    const sidebar = new bootstrap.Offcanvas(document.getElementById('sidebarOffcanvas'));
    sidebar.toggle();
}

function closeSidebar() {
    const sidebar = bootstrap.Offcanvas.getInstance(document.getElementById('sidebarOffcanvas'));
    if (sidebar) {
        sidebar.hide();
    }
}

// تحديث شارات الإشعارات في كلا المكانين
function updateNotificationBadges(count) {
    const mainBadge = document.getElementById('notificationBadge');
    const sidebarBadge = document.getElementById('sidebarNotificationBadge');
    
    if (count > 0) {
        if (mainBadge) {
            mainBadge.textContent = count;
            mainBadge.style.display = 'inline';
        }
        if (sidebarBadge) {
            sidebarBadge.textContent = count;
            sidebarBadge.style.display = 'inline';
        }
    } else {
        if (mainBadge) mainBadge.style.display = 'none';
        if (sidebarBadge) sidebarBadge.style.display = 'none';
    }
}

// تحسين دالة showSection لإخفاء كل شيء عدا القسم المطلوب
function showSection(sectionId) {
    // إخفاء جميع الأقسام
    const sections = ['transactions', 'notifications'];
    sections.forEach(section => {
        const element = document.getElementById(section);
        if (element) {
            element.style.display = 'none';
        }
    });

    // إظهار القسم المطلوب
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.style.display = 'block';
        targetSection.classList.add('fade-in');
    }

    // تحديث القائمة النشطة في الشريط الجانبي
    const navItems = document.querySelectorAll('.list-group-item');
    navItems.forEach(item => {
        item.classList.remove('active');
    });

    // تفعيل العنصر المناسب
    const targetNavItem = document.querySelector(`[onclick*="showSection('${sectionId}')"]`);
    if (targetNavItem) {
        targetNavItem.classList.add('active');
    }

    // تحميل البيانات حسب القسم
    setTimeout(() => {
        switch (sectionId) {
            case 'transactions':
                if (typeof loadUserTransactions === 'function') {
                    loadUserTransactions();
                }
                break;
            case 'notifications':
                if (typeof loadNotifications === 'function') {
                    loadNotifications();
                }
                break;
        }
    }, 200);
}

// تحسين واجهة تغيير كلمة المرور
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordField = document.getElementById('newPassword');
    const confirmPasswordField = document.getElementById('confirmPassword');
    const changePasswordBtn = document.getElementById('changePasswordBtn');

    if (newPasswordField) {
        newPasswordField.addEventListener('input', function() {
            checkPasswordStrength(this.value);
            validatePasswordMatch();
        });
    }

    if (confirmPasswordField) {
        confirmPasswordField.addEventListener('input', validatePasswordMatch);
    }

    function checkPasswordStrength(password) {
        const strengthDiv = document.getElementById('passwordStrength');
        if (!strengthDiv) return;

        let strength = 0;
        let feedback = [];

        // طول كلمة المرور
        if (password.length >= 8) {
            strength += 25;
        } else if (password.length >= 6) {
            strength += 15;
            feedback.push('قصيرة نسبياً');
        } else {
            feedback.push('قصيرة جداً');
        }

        // احتواء أرقام
        if (/\d/.test(password)) {
            strength += 25;
        } else {
            feedback.push('أضف أرقام');
        }

        // احتواء أحرف كبيرة وصغيرة
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) {
            strength += 25;
        } else {
            feedback.push('أضف أحرف كبيرة وصغيرة');
        }

        // احتواء رموز خاصة
        if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
            strength += 25;
        } else {
            feedback.push('أضف رموز خاصة');
        }

        let strengthText = '';
        let strengthClass = '';

        if (strength >= 75) {
            strengthText = 'قوية جداً';
            strengthClass = 'text-success';
        } else if (strength >= 50) {
            strengthText = 'قوية';
            strengthClass = 'text-info';
        } else if (strength >= 25) {
            strengthText = 'متوسطة';
            strengthClass = 'text-warning';
        } else {
            strengthText = 'ضعيفة';
            strengthClass = 'text-danger';
        }

        strengthDiv.innerHTML = `
            <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar ${strengthClass.replace('text-', 'bg-')}" style="width: ${strength}%"></div>
            </div>
            <small class="${strengthClass}">
                <i class="fas fa-shield-alt me-1"></i>
                قوة كلمة المرور: ${strengthText}
                ${feedback.length > 0 ? ' - ' + feedback.join(', ') : ''}
            </small>
        `;
    }

    function validatePasswordMatch() {
        const newPassword = newPasswordField?.value || '';
        const confirmPassword = confirmPasswordField?.value || '';
        const matchDiv = document.getElementById('passwordMatch');
        
        if (!matchDiv || !confirmPassword) return;

        if (newPassword === confirmPassword) {
            matchDiv.innerHTML = '<small class="text-success"><i class="fas fa-check me-1"></i>كلمات المرور متطابقة</small>';
            if (changePasswordBtn) changePasswordBtn.disabled = false;
        } else {
            matchDiv.innerHTML = '<small class="text-danger"><i class="fas fa-times me-1"></i>كلمات المرور غير متطابقة</small>';
            if (changePasswordBtn) changePasswordBtn.disabled = true;
        }
    }
});

// تبديل رؤية كلمة المرور
function togglePasswordVisibility(fieldId, toggleId) {
    const field = document.getElementById(fieldId);
    const toggle = document.getElementById(toggleId);
    
    if (field && toggle) {
        if (field.type === 'password') {
            field.type = 'text';
            toggle.className = 'fas fa-eye-slash';
        } else {
            field.type = 'password';
            toggle.className = 'fas fa-eye';
        }
    }
}

// تحديث الوقت
function updateLastLoginTime() {
    const timeElement = document.getElementById('lastLoginTime');
    if (timeElement) {
        const now = new Date();
        timeElement.textContent = now.toLocaleString('ar-EG', {
            calendar: 'gregory',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
}

// تحديث نص الإعلان
function updateAnnouncementText() {
    // تحديث نص الإعلان من إعدادات الموقع عند تحميل الصفحة
    if (typeof loadSiteSettings === 'function') {
        loadSiteSettings().then(() => {
            // سيتم تحديث النص في دالة loadSiteSettings
        }).catch(() => {
            console.log('استخدام النص الافتراضي للإعلان');
        });
    }
}

// تشغيل تحديث الوقت والإعلان عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    updateLastLoginTime();
    updateAnnouncementText();
});</old_str>

// دالة إظهار نافذة إعلان النظام
function showAnnouncementModal() {
    // التحقق من وجود النافذة
    const modal = document.getElementById('announcementModal');
    const textElement = document.getElementById('announcementModalText');
    
    if (!modal || !textElement) {
        showAlert('نافذة الإعلان غير متاحة', 'error');
        return;
    }

    // تحديث نص الإعلان من إعدادات الموقع
    const announcementText = document.getElementById('announcementText');
    if (announcementText && announcementText.textContent) {
        textElement.textContent = announcementText.textContent;
    } else {
        textElement.textContent = 'مرحباً بكم في نظام تسديد الفواتير';
    }
    
    // إظهار النافذة
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// إظهار الصفحة الرئيسية عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // إخفاء جميع الأقسام في البداية
    const sections = ['transactions', 'notifications'];
    sections.forEach(section => {
        const element = document.getElementById(section);
        if (element) {
            element.style.display = 'none';
        }
    });
});
</script>

<style>
.stats-card-modern {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    border-radius: 15px;
    overflow: hidden;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.stats-card-modern:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1), 0 5px 15px rgba(0,0,0,0.08);
}

.service-card-modern {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    border-radius: 15px;
    overflow: hidden;
    cursor: pointer;
    position: relative;
}

.service-card-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0,123,255,0.1) 0%, rgba(111,66,193,0.1) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.service-card-modern:hover::before {
    opacity: 1;
}

.service-card-modern:hover {
    transform: translateY(-10px) scale(1.03);
    box-shadow: 0 20px 40px rgba(0,123,255,0.15), 0 8px 20px rgba(111,66,193,0.1);
}

.avatar-circle {
    transition: transform 0.3s ease;
}

.avatar-circle:hover {
    transform: scale(1.1);
}

.list-group-item {
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
}

.list-group-item:hover {
    background-color: #f8f9fa;
    border-left-color: #007bff;
    transform: translateX(-3px);
}

.list-group-item.active {
    background: linear-gradient(45deg, #007bff, #6f42c1);
    border-left-color: #0056b3;
    transform: translateX(-3px);
}

.section-content {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stat-icon, .service-icon {
    transition: transform 0.3s ease;
}

.stats-card-modern:hover .stat-icon,
.service-card-modern:hover .service-icon {
    transform: scale(1.1);
}

.info-item {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.info-item:last-child {
    border-bottom: none;
}

.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,0.1);
    cursor: pointer;
}

.modal-content {
    border-radius: 15px;
    overflow: hidden;
}

.modal-header {
    border-bottom: none;
}

.modal-footer {
    border-top: 1px solid #e9ecef;
}

.progress {
    border-radius: 10px;
}

.alert {
    border-radius: 10px;
}

.btn {
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

/* تحسين القائمة الجانبية */
.offcanvas {
    border-radius: 0 15px 15px 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.offcanvas-header {
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

/* تحسين الحاوية الرئيسية */
.container-fluid {
    background: linear-gradient(135deg, #f4f6f8 0%, #e8f0fe 100%);
    min-height: 100vh;
    padding-top: 20px;
    padding-bottom: 40px;
}

/* تحسين الاستجابة للشاشات الصغيرة */
@media (max-width: 768px) {
    .modal-dialog {
        margin: 1rem;
    }
    
    .service-card-modern {
        margin-bottom: 1rem;
    }
    
    .stats-card-modern {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}
